<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="dark">
    <div class="login-box">
        <h1>Hello Boss…</h1>
        <div class="input-container secure-element">
            <input type="password" id="security-id-input" class="input-box" placeholder="Security-ID">
            <button type="button" id="toggle-password-visibility" class="toggle-password">•</button>
        </div>
    </div>

    <script type="module">
        import { setLoggedInUser, registerSessionWithServer, getLoggedInUser, authenticateUser } from './db.js';

        document.addEventListener('DOMContentLoaded', () => {
            const securityIdInput = document.getElementById('security-id-input');
            const togglePasswordButton = document.getElementById('toggle-password-visibility'); // Get the new button
            const loginScreen = document.getElementById('login-screen');
            let debounceTimer;
            
            // Check if user is already logged in
            const loggedInUser = getLoggedInUser();
            if (loggedInUser) {
                // User is already logged in, redirect to main page
                window.location.href = 'index.html';
                return;
            }

            togglePasswordButton.addEventListener('click', () => {
                if (securityIdInput.type === 'password') {
                    securityIdInput.type = 'text';
                    togglePasswordButton.textContent = '—'; // Changed from 🔒 to a dash
                } else {
                    securityIdInput.type = 'password';
                    togglePasswordButton.textContent = '•'; // Changed from 👁️ to a bullet point
                }
            });

            securityIdInput.addEventListener('input', () => {
                securityIdInput.classList.remove('correct', 'wrong');
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    const enteredId = securityIdInput.value;
                    if (enteredId.length === 0) {
                        return;
                    }

                    // Use server-side authentication instead of client-side validation
                    const userData = await authenticateUser(enteredId);

                    if (userData) {
                        setLoggedInUser(userData); // Store logged-in user with timestamp
                        securityIdInput.classList.add('correct');
                        setTimeout(() => {
                            loginScreen.style.opacity = '0';
                            loginScreen.addEventListener('transitionend', () => {
                                // Register session with the server
                                registerSessionWithServer(userData).then(() => {
                                    window.location.href = 'index.html';
                                });
                            }, { once: true });
                        }, 1000);
                    } else {
                        securityIdInput.classList.add('wrong');
                    }
                }, 1500);
            });
            securityIdInput.focus();
            securityIdInput.setAttribute('inputmode', 'numeric');
            securityIdInput.setAttribute('pattern', '[0-9]*');
        });
    </script>
</body>
</html> 