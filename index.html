<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Access</title>
    <style>
        /* =====================================================================
         * FARBSCHEMA UND DESIGN-VARIABLEN - EINFACH ZU BEARBEITEN
         * =====================================================================
         */
        :root {
            /* Grundfarben */
            --background-color: #111111;
            --text-color: #f0f0f0;
            --subtle-text-color: #a0a0a0;
            
            /* UI-Elemente */
            --glass-background: rgba(45, 45, 45, 0.5);
            --glass-border: rgba(255, 255, 255, 0.1);
            --scroll-bar-thumb: #555;
            --scroll-bar-track: #2a2a2a;
            
            /* Akzentfarben */
            --glow-green: #00ff7f;
            --glow-red: #ff4d4d;
            --subtle-red-color: #cc6666;
            
            /* Farbverläufe */
            --green-gradient: linear-gradient(135deg, #00ff7f, #00cc66);
            --owner-gradient: linear-gradient(135deg, #6c004a, #2665b1, #7e39de, #77008f, #ca0b0b5e, #5e0370);
            
            /* Benutzer-Glow-Farben - für designType-Styles */
            --owner-glow-colors: 0 0 4px 1px #388aa8, 0 0 6px 1px #610728, 0 0 3px 1px #610873;
            --request-glow-colors: 0 0 6px 1px #850000, 0 0 10px 2px #850000, 0 0 8px 1px #ffffff, 0 0 6px 1px #850000;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }
        @keyframes fade-glow {
            to { 
                border-color: var(--glass-border);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); 
            }
        }
        @keyframes owner-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes glow-green {
            0% { 
                border-color: var(--glass-border);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); 
            }
            100% { 
                border-color: var(--glow-green);
                box-shadow: 0 0 25px 10px rgba(0, 255, 127, 0.5), 
                           0 0 50px 15px rgba(0, 255, 127, 0.3),
                           0 4px 20px rgba(0, 0, 0, 0.2);
            }
        }
        @keyframes glow-red {
            0% { 
                border-color: var(--glass-border);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); 
            }
            100% { 
                border-color: var(--glow-red);
                box-shadow: 0 0 25px 10px rgba(255, 77, 77, 0.5), 
                           0 0 50px 15px rgba(255, 77, 77, 0.3),
                           0 4px 20px rgba(0, 0, 0, 0.2);
            }
        }
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        @keyframes slideFromRight {
            from { 
                opacity: 0;
                transform: translateX(30px) scale(0.9); 
            }
            to { 
                opacity: 1;
                transform: translateX(0) scale(1); 
            }
        }
        @keyframes scaleInSmooth {
            from { 
                opacity: 0;
                transform: scale(0.85); 
            }
            to { 
                opacity: 1;
                transform: scale(1); 
            }
        }
        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            position: relative;
            padding-top: 60px;
        }
        
        #rain-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.5;
            filter: blur(0.6px);
        }
        .screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh;
            position: absolute;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hidden {
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }
        .glassy-input {
            background: var(--glass-background);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px 20px;
            color: var(--text-color);
            font-size: 1.1rem;
            text-align: center;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
        }
        .glassy-input::placeholder {
            color: var(--subtle-text-color);
            opacity: 1;
        }
        .glassy-input:focus {
            outline: none;
        }
        .glassy-input:focus:not(.correct):not(.wrong) {
            border-color: var(--glass-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .glassy-input.correct {
            animation: glow-green 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards, fade-glow 2s ease-out 1.5s forwards !important;
        }
        .glassy-input.wrong {
            animation: glow-red 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards, fade-glow 2s ease-out 1.5s forwards !important;
        }
        #main-screen {
            justify-content: flex-start;
            padding-top: 5vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
        #main-screen .search-bar {
            position: relative;
            color: var(--text-color);
            background: var(--glass-background);
            border: 1px solid var(--glass-border);
            border-bottom: none;
            border-radius: 12px;
            padding: 15px 45px 15px 20px;
            font-size: 1.1rem;
            width: min(450px, 80vw);
            margin-bottom: 15px;
            transition: box-shadow 0.3s, border-bottom 0.3s, background 0.3s, margin-bottom 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        border-radius 0.3s cubic-bezier(0.4, 0, 0.2, 1) 0.5s;
            text-indent: 0;
            font-size: initial;
            text-align: left;
        }
        #main-screen .search-bar:focus {
            outline: none;
            box-shadow: 0 8px 24px 0 rgba(0,0,0,0.25);
        }
        #main-screen .search-bar.has-value {
            box-shadow: 0 8px 24px 0 rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--glass-border);
            border-radius: 12px 12px 0 0;
            margin-bottom: 0;
            transition: box-shadow 0.3s, border-bottom 0.3s, background 0.3s, margin-bottom 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        border-radius 0s;
        }
        /* Hide default search cancel button */
        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: none;
            display: none;
        }
        
        input[type="search"]::-webkit-search-cancel-button::before {
            content: 'x';
            color: white;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            line-height: 1;
        }
        .search-results-container {
            width: min(450px, 80vw);
            background: rgba(45, 45, 45, 0.4);
            border: none;
            border-radius: 0 0 12px 12px;
            padding: 0;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        padding 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        border 0.1s ease 0.4s;
            box-shadow: 0 12px 32px 0 rgba(0,0,0,0.15);
            transform: translateY(0);
            pointer-events: none;
            box-sizing: border-box;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin: 0 auto;
            z-index: 10; /* Increased z-index to ensure it displays on top */
        }
        #main-screen .search-bar.has-value + .search-results-container {
            max-height: 200px; /* Fixed height to enable scrolling */
            opacity: 1;
            padding: 10px 0;
            margin-bottom: 0;
            pointer-events: all;
            border: 1px solid var(--glass-border);
            border-top: none;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        padding 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                        border 0.3s ease 0s;
        }
        
        #main-screen .search-bar.has-value ~ .main-title-container {
            margin-top: 80px;
            transition: margin-top 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .search-results-list {
            color: var(--text-color);
            font-size: 1rem;
            padding: 5px 15px 12px 15px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-height: 180px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-bar-thumb) var(--scroll-bar-track);
        }
        
        /* Scrollbar styling for WebKit browsers (Chrome, Safari) */
        .search-results-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .search-results-list::-webkit-scrollbar-track {
            background: var(--scroll-bar-track);
            border-radius: 4px;
        }
        
        .search-results-list::-webkit-scrollbar-thumb {
            background-color: var(--scroll-bar-thumb);
            border-radius: 4px;
        }
        .search-result-item {
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--subtle-red-color);
            margin-bottom: 4px;
            transition: all 0.2s ease;
            cursor: default;
            font-size: 0.95rem;
            background: rgba(30, 30, 30, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .search-result-item:last-child {
            margin-bottom: 0;
        }
        .search-result-item.clickable {
            color: var(--text-color);
            cursor: pointer;
            background: rgba(45, 45, 45, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .search-result-item.clickable:hover {
            background: rgba(60, 60, 60, 0.7);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        #main-screen .main-title {
            font-size: 2.5rem;
            font-weight: 600;
            margin-top: 30px;
            margin-bottom: 10px;
            padding-top: 0;
            transition: padding-top 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #main-screen .search-bar.has-value ~ .main-title {
            padding-top: 10px;
        }
        
        .main-title-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            box-sizing: border-box;
            margin-top: 30px;
        }
        
        .main-title {
            text-align: center;
            margin-top: 5px;
        }
        
        .view-all-button {
            background: var(--glass-background);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 8px 20px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
            margin-bottom: 0px;
        }
        
        .view-all-button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        @media (max-width: 768px) {
            .view-all-button {
                font-size: 0.85rem;
                padding: 6px 16px;
            }
            
            #main-screen .main-title {
                font-size: 2.2rem;
                margin-top: 5px;
                margin-bottom: 30px;
            }
            
            .main-title-container {
                margin-top: 60px;
            }
            
            #main-screen .search-bar.has-value ~ .main-title-container {
                margin-top: 60px;
            }
            
            .search-result-item {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            #main-screen .main-title {
                font-size: 1.8rem;
                margin-top: 5px;
            }
            
            .main-title-container {
                margin-top: 40px;
            }
            
            .view-all-button {
                font-size: 0.8rem;
                padding: 5px 14px;
            }
            
            .placeholder-image {
                min-width: 150px;
                width: 150px;
                height: 210px;
                font-size: 1rem;
            }
            
            #main-screen .search-bar.has-value ~ .main-title-container {
                margin-top: 50px;
            }
            
            .search-result-item {
                padding: 8px 10px;
                font-size: 0.85rem;
            }
        }
        
        /* --- Gallery Styles --- */
        .gallery-container {
            display: flex;
            width: 100vw;
            overflow-x: hidden;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
            margin-top: 20px;
            margin-bottom: 60px;
            padding: 30px 0;
            position: relative;
            justify-content: center;
            user-select: none; /* Prevent text selection while dragging */
            touch-action: pan-x; /* Enable horizontal pan gesture */
            cursor: grab;
        }
        
        .gallery-container::-webkit-scrollbar {
            display: none; /* Hide scrollbar */
        }
        
        .gallery-content {
            display: none !important; /* Hide old carousel */
        }
        
        .album-item-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1), box-shadow 0.4s;
            border-radius: 15px;
            padding: 15px 5px;
            margin: 10px 0;
        }
        .album-item-wrapper:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18) !important;
        }
        .placeholder-image {
            min-width: 200px;
            width: 200px;
            height: 280px;
            background: var(--glass-background);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            box-shadow: none !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--subtle-text-color);
            font-size: 1.1rem;
            flex-shrink: 0;
            transition: all 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            will-change: transform, opacity;
            opacity: 0;
            z-index: 0;
            text-align: center;
            padding: 0;
        }
        .placeholder-image.active {
            display: flex;
            z-index: 3;
            opacity: 1;
            transform: scale(1.08);
            transition: all 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
            margin-top: 0;
            margin-bottom: 0;
        }
        .placeholder-image .placeholder-text {
            margin-bottom: 0;
            font-weight: 500;
            color: var(--text-color);
        }
        .album-name {
            font-size: 0.9em;
            color: var(--subtle-text-color);
            margin-top: 15px;
            margin-bottom: 10px;
            text-align: center;
            max-width: 200px;
            word-wrap: break-word;
            font-weight: bold;
        }
        .placeholder-image.left1, .placeholder-image.right1 {
            display: flex;
            opacity: 0.8;
            z-index: 2;
            transform: scale(0.96) translateY(5px);
            transition: all 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .placeholder-image.left2, .placeholder-image.right2 {
            display: flex;
            opacity: 0.5;
            z-index: 1;
            transform: scale(0.92) translateY(10px);
            transition: all 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .placeholder-image:not(.active):not(.left1):not(.right1):not(.left2):not(.right2) {
            display: none; /* Remove from document flow */
            opacity: 0;
        }
        .placeholder-image:hover {
            box-shadow: none !important;
            border-color: var(--glass-border) !important;
            transform: none !important;
        }
        .request-section {
            width: 100%;
            max-width: 600px;
            margin: 20px auto 80px auto;
            padding: 0 20px;
            box-sizing: border-box;
            position: relative;
        }
        
        /* Chat Pill Button */
        .chat-pill {
            position: absolute;
            right: auto;
            left: 50%;
            transform: translateX(-50%);
            top: -40px;
            background: var(--glass-background);
            color: var(--text-color);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 8px 20px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }
        
        .chat-pill:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Chat Modal */
        #chat-modal-overlay {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        #chat-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        #chat-modal {
            width: calc(100vw - 40px);
            height: calc(100vh - 40px);
            max-width: none;
            max-height: none;
            padding: 25px;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            animation: scaleInSmooth 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px 5px;
            display: flex;
            flex-direction: column-reverse; /* Most recent messages at bottom */
            gap: 10px;
            margin-bottom: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--scroll-bar-thumb) var(--scroll-bar-track);
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: var(--scroll-bar-track);
            border-radius: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: var(--scroll-bar-thumb);
            border-radius: 4px;
        }
        
        .chat-input-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .chat-username-row {
            display: flex;
            margin-bottom: 5px;
        }
        
        #chat-username {
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 8px 15px;
            color: var(--text-color);
            font-size: 0.9rem;
            width: 200px;
        }
        
        .chat-message-row {
            display: flex;
            gap: 10px;
        }
        
        #chat-input {
            flex: 1;
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 12px 15px;
            color: var(--text-color);
            font-size: 1rem;
        }
        
        #chat-send-button {
            padding: 0 20px;
            background: var(--green-gradient);
            border: none;
            border-radius: 8px;
            color: #111;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        #chat-send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 255, 127, 0.3);
        }
        
        .chat-message {
            padding: 12px 15px;
            border-radius: 12px;
            background: rgba(45, 45, 45, 0.7);
            border: 1px solid var(--glass-border);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            position: relative;
            text-align: left;
        }
        
        .chat-message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        
        .chat-message-sender {
            font-weight: bold;
        }
        
        .chat-message-text {
            word-break: break-word;
        }
        
        .chat-message-time {
            font-size: 0.75rem;
            color: var(--subtle-text-color);
            white-space: nowrap;
            margin-left: 10px;
        }
        
        .chat-message-expiry {
            position: absolute;
            right: 15px;
            bottom: 12px;
            font-size: 0.75rem;
            color: var(--subtle-red-color);
        }
        
        /* Unique design types for chat messages */
        .chat-message.owner {
            background: rgba(45, 45, 45, 0.85);
            border: 1px solid rgba(104, 51, 153, 0.5);
            box-shadow: 0 0 10px rgba(104, 51, 153, 0.2);
        }
        
        .chat-message.green-member {
            background: rgba(45, 45, 45, 0.7);
            border: 1px solid rgba(0, 255, 127, 0.2);
        }
        
        .chat-message.prem-gold-pulse {
            background: rgba(45, 45, 45, 0.85);
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.15);
        }
        @keyframes rocket-launch {
            0% {
                transform: scale(1) translateX(0) translateY(0) rotate(0deg);
                opacity: 1;
            }
            20% {
                transform: scale(1.1) translateX(0) translateY(-5px) rotate(5deg);
            }
            100% {
                transform: scale(0.3) translateX(200px) translateY(-300px) rotate(45deg);
                opacity: 0;
            }
        }
        @keyframes button-bounce-in {
            0% {
                opacity: 0;
                transform: scale(0) translateY(30px) rotate(-180deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) translateY(-10px) rotate(-90deg);
            }
            70% {
                transform: scale(0.9) translateY(5px) rotate(-20deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0) rotate(0deg);
            }
        }
        .input-form {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 40px;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 60px;
            justify-content: center;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        .input-wrapper.primary {
            width: 350px;
            flex-shrink: 0;
        }
        .input-wrapper.secondary {
            width: 0;
            min-width: 0;
            margin: 0;
            padding: 0;
            opacity: 0;
            overflow: hidden;
            transform: translateX(-20px);
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-wrapper.secondary.visible {
            width: 180px;
            min-width: 180px;
            opacity: 1;
            margin-left: 0;
            padding: 0;
            transform: translateX(0);
        }
        .input-wrapper input {
            width: 100%;
            transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
        }
        .input-wrapper.primary input {
            text-align: center
        }
        .input-wrapper.primary input:focus,
        .input-wrapper.primary input:not(:placeholder-shown) {
            text-align: left;
        }
        .input-wrapper.primary.shifted input {
            text-align: left;
        }
        .send-button {
            background: var(--green-gradient);
            border: none;
            border-radius: 12px;
            padding: 15px 20px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            opacity: 0;
            transform: scale(0) translateY(30px) rotate(-180deg);
            pointer-events: none;
            width: 0;
            min-width: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: relative;
        }
        .send-button.visible {
            animation: button-bounce-in 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            pointer-events: all;
            width: 80px;
            min-width: 80px;
            opacity: 1;
            margin-left: 0;
            padding: 15px 20px;
            transform: scale(1) translateY(0) rotate(0deg);
        }
        .send-button:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 127, 0.4);
        }
        .send-button:active {
            transform: scale(0.95);
        }
        .send-button.launching {
            animation: rocket-launch 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            pointer-events: none;
        }
        .requests-list {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: hidden; /* Hide scrolling by default */
            scrollbar-width: none; /* Hide scrollbar in Firefox */
            -ms-overflow-style: none; /* Hide scrollbar in IE/Edge */
            padding: 0 10px; /* Add padding to prevent glow effect from being cut off */
            margin: 0 -10px; /* Negative margin to compensate for padding */
        }

        /* Enable scrolling when there are more than 4 requests */
        .requests-list.scrollable {
            overflow-y: auto; /* Enable vertical scrolling */
            max-height: 400px; /* Set max height to enable scrolling */
        }

        /* Hide scrollbar in WebKit browsers (Chrome, Safari) */
        .requests-list::-webkit-scrollbar {
            display: none;
        }

        .requests-list h4 {
            color: var(--text-color);
            font-size: 1.2rem;
            margin-bottom: 20px;                               
            margin-top: 0;
        }
        .request-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #1a1a2e;
            border-radius: 12px;
            margin-bottom: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 6px 1px #1a1a2e, 0 0 10px 2px #0f3460, 0 0 8px 1px #533483, 0 0 6px 1px #2d0036;
            animation: request-glow 3s linear infinite;
            position: relative; /* Ensure glow effect is positioned relative to the item */
            z-index: 1; /* Ensure items appear above each other */
        }

        /* Add extra space to the last request item to ensure it's not cut off when scrolling */
        .requests-list.scrollable .request-item:last-child {
            margin-bottom: 20px;
        }
        @keyframes request-glow {
            0% {
                box-shadow: 0 0 6px 1px #1a1a2e, 0 0 10px 2px #0f3460, 0 0 8px 1px #533483, 0 0 6px 1px #2d0036;
                border-color: #1a1a2e;
            }
            25% {
                box-shadow: 0 0 8px 2px #0f3460, 0 0 12px 3px #533483, 0 0 6px 1px #2d0036, 0 0 10px 2px #1a1a2e;
                border-color: #0f3460;
            }
            50% {
                box-shadow: 0 0 12px 3px #533483, 0 0 6px 1px #2d0036, 0 0 8px 2px #1a1a2e, 0 0 10px 2px #0f3460;
                border-color: #533483;
            }
            75% {
                box-shadow: 0 0 6px 1px #2d0036, 0 0 10px 2px #1a1a2e, 0 0 8px 1px #0f3460, 0 0 12px 3px #533483;
                border-color: #2d0036;
            }
            100% {
                box-shadow: 0 0 6px 1px #1a1a2e, 0 0 10px 2px #0f3460, 0 0 8px 1px #533483, 0 0 6px 1px #2d0036;
                border-color: #1a1a2e;
            }
        }
        .request-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .album-container .album {
            box-shadow: none !important;
            filter: none !important;
            position: relative !important;
        }
        .album-container .album:nth-child(6) {
            box-shadow: none !important;
            filter: none !important;
            position: relative !important;
        }
        .request-username {
            font-weight: 600;
            color: var(--glow-green);
            min-width: 60px;
            margin-right: 8px;
        }
        
        /* =====================================================================
         * BENUTZERTYP-STYLES - EINFACH ZU BEARBEITEN
         * =====================================================================
         * 
         * Um einen neuen Benutzertyp hinzuzufügen:
         * 1. Füge eine neue CSS-Klasse für .request-username.[designType] hinzu
         * 2. Optional: Füge eine CSS-Klasse für .request-item.[designType] hinzu
         * 3. Füge den neuen designType auf dem Server in der userAccounts-Liste hinzu
         *    (in der server.js-Datei, nicht mehr in db.js)
         * 
         * Beispiel für einen neuen Benutzertyp:
         * .request-username.vip-user {
         *     font-weight: 600;
         *     color: gold;
         *     border-radius: 6px;
         *     padding: 2px 10px;
         * }
         * 
         * .request-item.vip-user {
         *     box-shadow: 0 0 10px gold;
         *     animation: vip-glow 3s linear infinite;
         * }
         */
        
        /* =====================================================================
         * ANIMATION TEMPLATES - READY TO USE
         * =====================================================================
         */
        
        /* 1. Standard Member Style (already existing) */
        .request-username.green-member {
            font-weight: 600;
            color: var(--glow-green);
            border-radius: 6px;
            padding: 2px 10px;
        }
        
        .request-item.green-member {
            box-shadow: none;
            animation: none;
            border-color: rgba(119, 119, 119, 0.1); /* A subtle border for non-glowing items */
        }
        
        /* 2. LeftRightGrad - Gradient animation with glow (based on owner style) */
        @keyframes leftright-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes leftright-glow {
            0% {
                box-shadow: 0 0 4px 1px var(--leftright-color1), 0 0 6px 1px var(--leftright-color2), 0 0 4px 1px var(--leftright-color3);
                border-color: var(--leftright-color1);
            }
            25% {
                box-shadow: 0 0 5px 1px var(--leftright-color2), 0 0 7px 2px var(--leftright-color3), 0 0 4px 1px var(--leftright-color4);
                border-color: var(--leftright-color2);
            }
            50% {
                box-shadow: 0 0 6px 2px var(--leftright-color3), 0 0 4px 1px var(--leftright-color4), 0 0 5px 1px var(--leftright-color1);
                border-color: var(--leftright-color3);
            }
            75% {
                box-shadow: 0 0 4px 1px var(--leftright-color4), 0 0 6px 1px var(--leftright-color1), 0 0 5px 1px var(--leftright-color2);
                border-color: var(--leftright-color4);
            }
            100% {
                box-shadow: 0 0 4px 1px var(--leftright-color1), 0 0 6px 1px var(--leftright-color2), 0 0 4px 1px var(--leftright-color3);
                border-color: var(--leftright-color1);
            }
        }
        
        .request-username.leftright-grad {
            font-weight: 600;
            background: var(--leftright-gradient);
            background-size: 400% 400%;
            animation: leftright-gradient 3s linear infinite, leftright-glow 3s ease-in-out infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            border-radius: 6px;
            padding: 2px 10px;
            box-shadow: var(--leftright-text-glow);
        }
        
        .request-item.leftright-grad {
            box-shadow: 0 0 4px 1px var(--leftright-color1), 0 0 6px 1px var(--leftright-color2), 0 0 4px 1px var(--leftright-color3);
            animation: leftright-glow 3s linear infinite;
            border-color: var(--leftright-color1);
        }
        
        /* Example: Amo's style using the LeftRightGrad template */
        .request-username.owner {
            --leftright-gradient: linear-gradient(135deg, #6c004a, #2665b1, #7e39de, #77008f, #ca0b0b5e, #5e0370);
            --leftright-color1: #388aa8;
            --leftright-color2: #610728;
            --leftright-color3: #610873;
            --leftright-color4: #7e39de;
            --leftright-text-glow: 0 0 4px 1px #388aa8, 0 0 6px 1px #610728, 0 0 3px 1px #610873;
            font-weight: 600;
            background: var(--leftright-gradient);
            background-size: 400% 400%;
            animation: leftright-gradient 3s linear infinite, leftright-glow 3s ease-in-out infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            border-radius: 6px;
            padding: 2px 10px;
            box-shadow: var(--leftright-text-glow);
        }
        
        /* 3. SingleColorPulse - Pulsing glow with configurable single color */
        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 3px 1px var(--pulse-color);
                border-color: var(--pulse-color);
                filter: brightness(0.9);
            }
            50% {
                box-shadow: 0 0 8px 2px var(--pulse-color), 0 0 12px 3px var(--pulse-color-transparent);
                border-color: var(--pulse-color);
                filter: brightness(1.1);
            }
            100% {
                box-shadow: 0 0 3px 1px var(--pulse-color);
                border-color: var(--pulse-color);
                filter: brightness(0.9);
            }
        }
        
        .request-username.single-color-pulse {
            font-weight: 600;
            color: var(--pulse-color);
            border-radius: 6px;
            padding: 2px 10px;
            text-shadow: 0 0 5px var(--pulse-color-transparent);
            animation: pulse-glow 3s ease-in-out infinite;
        }
        
        .request-item.single-color-pulse {
            box-shadow: 0 0 3px 1px var(--pulse-color);
            border-color: var(--pulse-color);
            animation: pulse-glow 3s ease-in-out infinite;
        }
        
        /* Example: Blue pulsing style */
        .request-username.prem-gold-pulse {
            --pulse-color: #fff47e;
            --pulse-color-transparent: rgba(238, 255, 0, 0.656);
            font-weight: 600;
            color: var(--pulse-color);
            border-radius: 6px;
            padding: 2px 10px;
            text-shadow: 0 0 5px var(--pulse-color-transparent);
            animation: pulse-glow 3s ease-in-out infinite;
        }
        
        .request-item.prem-gold-pulse {
            --pulse-color: #fff47e;
            --pulse-color-transparent: rgba(238, 255, 0, 0.656);
            box-shadow: 0 0 5px 1px var(--pulse-color);
            border-color: var(--pulse-color);
            animation: pulse-glow 3s ease-in-out infinite;
        }

     
        /*....................................................................*/
        /* Request-Item Styles nach Benutzertyp */
        .request-item.green-member {
            box-shadow: none;
            animation: none;
            border-color: rgba(119, 119, 119, 0.1); /* A subtle border for non-glowing items */
        }



        .request-separator {
            margin: 0 15px;
            color: var(--subtle-text-color);
        }
        .request-text {
            flex-grow: 1;
            color: var(--text-color);
        }
        .request-time {
            color: var(--subtle-text-color);
            font-size: 0.9rem;
            margin-left: 15px;
        }
        @media (max-width: 768px) {
            .screen {
                height: 100vh;
                padding: 0;
            }
            #main-screen {
                padding-top: 5vh;
                overflow-y: auto;
                overflow-x: hidden;
            }
            #main-screen .search-bar {
                width: min(450px, 80vw);
                margin-bottom: 8vh;
            }
            #main-screen .main-title {
                font-size: 2.2rem;
                margin-top: 5px;
                margin-bottom: 30px;
            }
            .gallery-container {
                gap: 25px;
                width: 100vw;
                padding: 25px 0;
                margin-bottom: 50px;
            }
            
            .album-item-wrapper {
                padding: 12px 5px;
                margin: 8px 0;
            }
            
            .view-all-button {
                font-size: 0.85rem;
                padding: 6px 16px;
            }
            
            .main-title-container {
                margin-top: 60px;
            }

            .placeholder-image {
                min-width: 200px;
                width: 200px;
                height: 280px;
                font-size: 1.1rem;
            }
            .request-section {
                padding: 30px;
                width: min(800px, 80vw);
                min-height: 400px;
            }
            .input-form {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 40px;
                transition: all 1.2s cubic-bezier(0.4, 0, 0.2, 1);
                min-height: 60px;
                justify-content: center;
            }
            .input-wrapper.primary {
                width: 350px;
                flex-shrink: 0;
            }
            .input-wrapper.primary input {
                text-align: center;
            }
            .input-wrapper.primary.shifted input {
                text-align: left;
            }
            .send-button.visible {
                width: 80px;
                min-width: 80px;
            }
            .request-item {
                display: flex;
                align-items: center;
                flex-direction: row;
                gap: 0;
            }
            .request-separator {
                display: inline;
                margin: 0 15px;
            }
            .request-time {
                margin-left: 15px;
            }
        }
        @media (max-width: 480px) {
            #main-screen .main-title {
                font-size: 1.8rem;
                margin-top: 5px;
            }
            
            .main-title-container {
                margin-top: 40px;
            }
            
            .view-all-button {
                font-size: 0.8rem;
                padding: 5px 14px;
            }
            
            .gallery-container {
                padding: 20px 0;
                margin-bottom: 40px;
            }
            
            .album-item-wrapper {
                padding: 10px 5px;
                margin: 5px 0;
            }
            
            .placeholder-image {
                min-width: 150px;
                width: 150px;
                height: 210px;
                font-size: 1rem;
            }
            .gallery-content {
                padding-left: calc(50vw - 162.5px);
                padding-right: calc(50vw - 162.5px);
            }
            .glassy-input {
                font-size: 1rem;
                padding: 12px 16px;
            }
            .request-section {
                padding: 20px;
                min-height: 350px;
            }
            .input-wrapper.primary {
                width: 300px;
            }
        }
        /* Style for the ID Name Tooltip */
        #id-name-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            white-space: nowrap;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        /* Modal Content */
        .modal-content {
            background: var(--glass-background);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            width: min(500px, 95vw);
            max-height: 80vh;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            position: relative;
            transform: scale(0.7);
            opacity: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            pointer-events: auto;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .modal-header {
            display: flex;
            justify-content: flex-end;
        }
        .close-button {
            background: none;
            border: none;
            color: var(--subtle-text-color);
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0 5px;
            transition: color 0.2s ease;
        }
        .close-button:hover {
            color: var(--text-color);
        }
        .modal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 20px;
        }
        .modal-image-placeholder {
            width: 250px;
            height: 350px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--subtle-text-color);
            font-size: 0.9em;
        }
        .modal-album-name {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        .glassy-button {
            background: var(--glass-background);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px 25px;
            color: var(--text-color);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .glassy-button:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
        .glassy-button:active {
            transform: translateY(0);
        }
        .glassy-button.gradient-animated {
            background: linear-gradient(135deg, #a00050, #0000A0, #7300a0);
            background-size: 200% 200%;
            animation: owner-gradient 3s ease-in-out infinite;
            color: white;
            border: none;
        }
        .glassy-button.gradient-animated:hover {
            box-shadow: 0 8px 25px rgba(143, 2, 91, 0.344);
        }
        .glassy-button.is-empty {
            opacity: 0.6;
            cursor: not-allowed !important;
            background: var(--glass-background) !important;
            color: var(--subtle-text-color) !important;
            border: 1px solid var(--glass-border) !important;
            box-shadow: none !important;
            animation: none !important;
        }
        .glassy-button.copied {
            background: #00FF7F !important;
            color: black !important;
            box-shadow: 0 0 15px 5px rgba(0, 255, 127, 0.6), 0 0 30px 10px rgba(0, 255, 127, 0.4) !important;
            animation: none !important;
        }
        .album-item-wrapper:not(:has(.placeholder-image.active)):not(:has(.placeholder-image.left1)):not(:has(.placeholder-image.right1)):not(:has(.placeholder-image.left2)):not(:has(.placeholder-image.right2)) {
            display: none;
            opacity: 0;
        }
        #initial-request-placeholder {
            box-shadow: none !important;
            animation: none !important;
            justify-content: flex-start;
            padding: 15px 20px;
            color: var(--subtle-text-color);
            font-style: normal;
            border: 1px solid var(--glass-border);
            background: var(--glass-background);
            display: flex;
            align-items: center;
        }

        .admin-toggle-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: transparent; /* No background */
            border: 1px solid transparent; /* Subtle border that can glow */
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem; /* Make it a bit larger to ensure visibility */
            font-weight: bold;
            color: white !important; /* Force white color */
            cursor: pointer;
            z-index: 9999; /* Higher z-index */
            box-shadow: none;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            pointer-events: auto !important;
            line-height: 0.8; /* Adjust line-height to center the dash */
        }

        .admin-toggle-button:hover {
            background: rgba(255, 255, 255, 0.1); /* Subtle hover background */
            color: white !important;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2); /* Subtle hover shadow */
            transform: translateY(-2px);
        }

        .admin-toggle-button:active {
            transform: translateY(0);
        }

        .admin-toggle-button.notification-active {
            animation: glow-red 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite alternate; /* Keep glow for active notification */
            color: var(--glow-red) !important;
            border-color: var(--glow-red);
            box-shadow: 0 0 15px 5px rgba(255, 77, 77, 0.5), 0 0 30px 10px rgba(255, 77, 77, 0.3); /* Enhanced glow */
        }

        .request-section.admin-mode .request-item {
            padding-right: 50px;
            position: relative;
        }

        .delete-request-button {
            background: var(--glow-red);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            color: white;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, background-color 0.3s ease;
        }

        .request-section.admin-mode .delete-request-button {
            opacity: 1;
            pointer-events: auto;
        }

        .delete-request-button:hover {
            background: #ff6666;
        }

        .delete-request-button:active {
            background: #cc3333;
        }
        /* Anti-tamper notification panel */
        .anti-tamper-notification-panel {
            position: fixed;
            bottom: 65px; /* Position above the admin button (button height + some margin) */
            right: 20px;
            background: var(--glass-background); /* Glassy background */
            border: 1px solid var(--glass-border); /* Glassy border */
            border-radius: 15px; /* Rounded corners */
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4); /* Subtle shadow */
            padding: 15px;
            width: 280px; /* Fixed width */
            max-height: 200px; /* Max height to allow scrolling */
            overflow-y: auto; /* Enable scrolling for multiple messages */
            color: var(--text-color);
            font-size: 0.95rem;
            line-height: 1.4;
            z-index: 9998; /* Below admin button's z-index */
            opacity: 0;
            visibility: hidden;
            /* Animation from slightly below its final position, moving up */
            transform: translateY(20px); /* Start 20px below its final `bottom: 65px` */
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; /* Use flex for internal content */
            flex-direction: column;
            gap: 10px; /* Space between messages */
        }

        .anti-tamper-notification-panel.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0); /* End at its `bottom: 65px` position */
        }

        .anti-tamper-notification-panel .message-item {
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            word-break: break-word;
            display: flex; /* Make it a flex container */
            justify-content: space-between; /* Space out content and button */
            align-items: center;
        }

        .anti-tamper-notification-panel .delete-anti-tamper-log-button {
            background: var(--subtle-red-color); /* Subtle red background */
            color: white; /* White 'x' */
            border: none;
            border-radius: 50%; /* Circular button */
            width: 20px; /* Small size */
            height: 20px;
            font-size: 0.8rem; /* Small font size for 'x' */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            flex-shrink: 0; /* Prevent button from shrinking */
            margin-left: 10px; /* Space from message text */
            transition: background-color 0.2s ease;
        }

        .anti-tamper-notification-panel .delete-anti-tamper-log-button:hover {
            background: #ff4d4d; /* Brighter red on hover */
        }

        .anti-tamper-notification-panel .clear-button {
            background: var(--subtle-red-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 10px;
            align-self: flex-end; /* Align to the right */
            transition: background-color 0.2s ease;
        }

        @media (max-width: 480px) {
            .admin-toggle-button {
                width: 30px;
                height: 30px;
                font-size: 1.2rem; /* Adjusted for smaller screens */
            }
            .anti-tamper-notification-panel {
                width: calc(100vw - 40px); /* Full width minus margin */
                right: 20px;
                left: 20px; /* Center for mobile */
                transform: translateY(20px); /* Keep consistent animation */
            }
            .anti-tamper-notification-panel.visible {
                transform: translateY(0);
            }
        }
        
        /* Albums Grid Styles */
        .albums-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            width: 100%;
            padding: 10px 10px 30px 10px;
            justify-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        
        .grid-album-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .grid-album-item:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .grid-album-image {
            width: 150px;
            height: 210px;
            background: var(--glass-background);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        
        .grid-album-name {
            margin-top: 10px;
            font-size: 0.9rem;
            text-align: center;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            .albums-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 15px;
            }
            
            .grid-album-image {
                width: 130px;
                height: 180px;
            }
        }
        
        .album-item-wrapper:not(:has(.placeholder-image.active)):not(:has(.placeholder-image.left1)):not(:has(.placeholder-image.right1)):not(:has(.placeholder-image.left2)):not(:has(.placeholder-image.right2)) {
            display: none;
            opacity: 0;
        }
        /* View All Albums Modal */
        #view-all-modal {
            max-width: 90vw;
            width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        #view-all-modal::-webkit-scrollbar {
            display: none; /* Chrome, Safari and Opera */
        }
        
        #view-all-modal .modal-body {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 0 20px 0;
        }
        
        #view-all-modal h3 {
            width: 100%;
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .report-album-button {
            background: none; 
            border: none; 
            color: var(--subtle-text-color); 
            font-size: 0.8rem; 
            cursor: pointer; 
            padding: 5px 10px; 
            border-radius: 12px; 
            transition: all 0.3s ease, opacity 0.2s ease, visibility 0.2s ease;
        }

        .report-album-button:hover {
            color: var(--text-color);
            background: rgba(255, 255, 255, 0.05);
        }

        .report-success-message {
            color: #00FF7F;
            font-size: 0.9rem;
            margin-top: 10px;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
            background: rgba(0, 255, 127, 0.1);
            opacity: 1;
            transition: opacity 0.3s ease;
            animation: fadeIn 0.2s ease-in-out;
        }
        /* Navigation Bar Styles */
        #top-nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 55px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(45, 45, 45, 0.25);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            /* subtle border tint */
            border-bottom: 1px solid rgba(255,255,255,0.06);
            z-index: 4000; /* below modal overlay */
        }
        #top-nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 40px;
        }
        #top-nav li {
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-color);
            transition: color 0.2s ease;
            user-select: none;
        }
        #top-nav li:hover {
            color: var(--glow-green);
        }
        #top-nav li.active {
            color: var(--glow-green);
        }
        /* ------------------------------------------------------------------
         * NEW 3D CAROUSEL STYLES
         * ------------------------------------------------------------------ */
        .carousel {
            position: relative;
            width: 100%;
            height: 500px;
            display: grid;
            place-items: center;
            transform: perspective(1000px) rotateX(70deg);
            transform-style: preserve-3d;
            animation: rotate 15s linear infinite;
            transition: all 1s;
            background-image: radial-gradient(circle at 50% 50%, #222 30%, transparent 40%);
        }
        .carousel:hover { animation-play-state: paused; }
        .carousel .card, .carousel .cardb {
            display: grid;
            place-items: center;
            width: 190px;
            height: 225px;
            position: absolute;
            border-radius: 5px;
            padding: 0;
        }
        .carousel .cardb { background-color: #1f1f1f; }
        .carousel .card {
            background-color: #333;
            box-shadow: 0 0 20px rgba(0,0,0,.5);
            -webkit-box-reflect: below 3px linear-gradient(transparent 75%, rgba(255,255,255,.125));
        }
        .carousel .card .img {
            width: 180px;
            height: 100px;
            border-radius: 3px;
            margin-bottom: -10px;
            filter: brightness(.7);
            background-size: 190px 190px;
            background-position: center;
            background-repeat: no-repeat;
        }
        .carousel .card p {
            font-size: 16px;
            margin-bottom: -5px;
            text-align: center;
        }
        .carousel .card span {
            font-size: 12px;
            text-align: center;
            padding: 8px;
        }
        @keyframes rotate { to { transform: perspective(1000px) rotateX(70deg) rotateZ(360deg); } }
        @media screen and (max-width: 992px) {
            .carousel { transform: perspective(1000px) rotateX(70deg) scale(.7); }
        }
        @keyframes nav-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Hard-coded transforms for carousel visibility */
        .carousel .c1 {transform-origin:center center;transform:rotateZ(45deg) rotateX(90deg) translateY(120px) translateZ(280px) rotateZ(180deg);} .carousel .cb1{transform:rotateZ(45deg) rotateX(90deg) translateY(120px) translateZ(279px);} 
        .carousel .c2 {transform-origin:center center;transform:rotateZ(90deg) rotateX(90deg) translateY(120px) translateZ(280px) rotateZ(180deg);} .carousel .cb2{transform:rotateZ(90deg) rotateX(90deg) translateY(120px) translateZ(279px);} 
        .carousel .c3 {transform-origin:center center;transform:rotateZ(135deg) rotateX(90deg) translateY(120px) translateZ(280px) rotateZ(180deg);} .carousel .cb3{transform:rotateZ(135deg) rotateX(90deg) translateY(120px) translateZ(279px);} 
        .carousel .c4 {transform-origin:center center;transform:rotateZ(180deg) rotateX(90deg) translateY(120px) translateZ(280px) rotateZ(180deg);} .carousel .cb4{transform:rotateZ(180deg) rotateX(90deg) translateY(120px) translateZ(279px);} 
        .carousel .c5 {transform-origin:center center;transform:rotateZ(225deg) rotateX(90deg) translateY(120px) translateZ(280px) rotateZ(180deg);} .carousel .cb5{transform:rotateZ(225deg) rotateX(90deg) translateY(120px) translateZ(279px);} 
        .carousel .c6 {transform-origin:center center;transform:rotateZ(270deg) rotateX(90deg) translateY(120px) translateZ(280px) rotateZ(180deg);} .carousel .cb6{transform:rotateZ(270deg) rotateX(90deg) translateY(120px) translateZ(279px);} 
        .carousel .c7 {transform-origin:center center;transform:rotateZ(315deg) rotateX(90deg) translateY(120px) translateZ(280px) rotateZ(180deg);} .carousel .cb7{transform:rotateZ(315deg) rotateX(90deg) translateY(120px) translateZ(279px);} 
        .carousel .c8 {transform-origin:center center;transform:rotateZ(0deg) rotateX(90deg) translateY(120px) translateZ(280px) rotateZ(180deg);}  .carousel .cb8{transform:rotateZ(0deg)  rotateX(90deg) translateY(120px) translateZ(279px);} 
    </style>
</head>
<body>
    <canvas id="rain-canvas"></canvas>
    <!-- Navigation Bar -->
    <nav id="top-nav">
        <ul>
            <li data-target="search" class="active">Search</li>
            <li data-target="chat">Chat</li>
            <li data-target="requests">Request</li>
        </ul>
    </nav>
    <div id="main-screen" class="screen">
        <div class="search-wrapper" style="position: relative; width: min(450px, 80vw); margin: 0 auto;">
        <input type="search" class="glassy-input search-bar" placeholder="Search...">
        <div class="search-results-container">
            <div class="search-results-list">
                    <!-- Search results will appear here -->
            </div>
        </div>
        </div>
        <div class="main-title-container">
            <button class="view-all-button">View All</button>
        <h2 class="main-title">Recently Added</h2>
        </div>
        <div class="gallery-container">
           <div class="gallery-content">
                <div class="album-item-wrapper">
                    <div class="placeholder-image"><div class="placeholder-text">G 1</div></div>
                    <div class="album-name">G Name 1</div>
                </div>
                <div class="album-item-wrapper">
                    <div class="placeholder-image"><div class="placeholder-text">G 2</div></div>
                    <div class="album-name">G Name 2</div>
                </div>
                <div class="album-item-wrapper">
                    <div class="placeholder-image"><div class="placeholder-text">G 3</div></div>
                    <div class="album-name">G Name 3</div>
                </div>
                <div class="album-item-wrapper">
                    <div class="placeholder-image"><div class="placeholder-text">G 4</div></div>
                    <div class="album-name">G Name 4</div>
                </div>
                <div class="album-item-wrapper">
                    <div class="placeholder-image"><div class="placeholder-text">G 5</div></div>
                    <div class="album-name">G Name 5</div>
                </div>
                <div class="album-item-wrapper">
                    <div class="placeholder-image"><div class="placeholder-text">G 6</div></div>
                    <div class="album-name">G Name 6</div>
                </div>
                <div class="album-item-wrapper">
                    <div class="placeholder-image"><div class="placeholder-text">G 7</div></div>
                    <div class="album-name">G Name 7</div>
                </div>
                <div class="album-item-wrapper">
                    <div class="placeholder-image"><div class="placeholder-text">G 8</div></div>
                    <div class="album-name">G Name 8</div>
                </div>
                <div class="album-item-wrapper">
                    <div class="placeholder-image"><div class="placeholder-text">G 9</div></div>
                    <div class="album-name">G Name 9</div>
                </div>
                <div class="album-item-wrapper">
                    <div class="placeholder-image"><div class="placeholder-text">G 10</div></div>
                    <div class="album-name">G Name 10</div>
                </div>
            </div>
        </div>
        <div class="request-section">
            <button class="chat-pill">Chat</button>
            <div class="input-form" id="input-form">
                <div class="input-wrapper primary" id="primary-wrapper">
                    <input type="text" id="request-input" class="glassy-input" placeholder="Make a request">
                </div>
                <div class="input-wrapper secondary" id="secondary-wrapper">
                    <input type="text" id="username-input" class="glassy-input" placeholder="Username">
                </div>
                 <button id="send-button" class="send-button">Send</button>
            </div>
            <div class="requests-list">
                <h4>Requests:</h4>
                <div id="initial-request-placeholder" class="request-item">
                    //
                </div>
            </div>
        </div>
        <!-- Admin Toggle Button -->
        <button id="admin-toggle-button" class="admin-toggle-button hidden">—</button>
    </div>
    
    <!-- Chat Modal -->
    <div id="chat-modal-overlay" class="modal-overlay hidden">
        <div id="chat-modal" class="modal-content glassy-input">
            <div class="modal-header">
                <div style="width: 20px;"></div>
                <h3 style="flex-grow: 1; text-align: center; margin: 0;">Chat</h3>
                <button class="close-button">&times;</button>
            </div>
            <div class="chat-messages" id="chat-messages">
                <!-- Chat messages will appear here -->
            </div>
            <div class="chat-input-area">
                <div class="chat-username-row">
                    <input type="text" id="chat-username" placeholder="Your Username...">
                </div>
                <div class="chat-message-row">
                    <input type="text" id="chat-input" placeholder="Type a message...">
                    <button id="chat-send-button">Send</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Album Detail Modal -->
    <div id="album-detail-modal-overlay" class="modal-overlay hidden">
        <div id="album-detail-modal" class="modal-content glassy-input">
            <div class="modal-header">
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-image-placeholder"></div>
                <h3 class="modal-album-name"></h3>
                <div class="modal-buttons">
                    <button class="glassy-button copy-acc-button">Copy ACC</button>
                    <button class="glassy-button copy-pw-button">Copy PW</button>
                </div>
                <div class="modal-edit-options" style="display:none; margin-top: 15px; justify-content: space-between; width: 100%;">
                    <button class="glassy-button edit-album-button">Edit G</button>
                    <button class="glassy-button delete-album-button">Delete</button>
            </div>
                <div class="report-button-container" style="margin-top: 15px; width: 100%; display: flex; justify-content: flex-end;">
                    <button class="report-album-button">Report?</button>
                </div>
                <div class="report-confirmation" style="display: none; margin-top: 10px; background: rgba(45, 45, 45, 0.7); padding: 10px; border-radius: 12px; width: 100%;">
                    <p style="margin: 0 0 10px 0; font-size: 0.9rem;">Report this Game?</p>
                    <div style="display: flex; justify-content: space-between; gap: 10px;">
                        <button class="glassy-button report-yes-button" style="flex: 1; background: rgba(255, 77, 77, 0.2);">Yes</button>
                        <button class="glassy-button report-no-button" style="flex: 1;">No</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Album Edit/Add Modal -->
    <div id="album-edit-modal-overlay" class="modal-overlay hidden">
        <div id="album-edit-modal" class="modal-content glassy-input">
            <div class="modal-header">
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <h3 id="album-edit-title">Edit G</h3>
                <form id="album-edit-form" style="width: 100%; display: flex; flex-direction: column; gap: 15px;">
                    <input type="hidden" id="edit-album-id">
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label for="edit-album-name">G Name:</label>
                        <input type="text" id="edit-album-name" class="glassy-input" required>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label for="edit-album-image-url">G URL:</label>
                        <input type="text" id="edit-album-image-url" class="glassy-input">
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label for="edit-album-acc">G ACC:</label>
                        <input type="text" id="edit-album-acc" class="glassy-input">
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px;">
                        <label for="edit-album-pw">G PW:</label>
                        <input type="text" id="edit-album-pw" class="glassy-input">
                    </div>
                    <div style="display: flex; justify-content: center; margin-top: 15px;">
                        <button type="submit" class="glassy-button gradient-animated" id="save-album-button">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- View All Albums Modal -->
    <div id="view-all-modal-overlay" class="modal-overlay hidden">
        <div id="view-all-modal" class="modal-content glassy-input">
            <div class="modal-header">
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <h3>All Games</h3>
                <div id="albums-grid" class="albums-grid">
                    <!-- Albums will be generated here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { getLoggedInUser, setLoggedInUser, getRequests, addRequest, deleteRequest, logoutUser, setRequestUpdateCallback, registerSessionWithServer, setAntiTamperNotificationCallback, getAntiTamperLogs, clearAntiTamperLogs, deleteAntiTamperLog, getAlbumItems, addAlbumItem, updateAlbumItem, deleteAlbumItem, setAlbumItemUpdateCallback, checkInactivity, getChatMessages, addChatMessage, deleteChatMessage, setChatMessageUpdateCallback } from './db.js';

        // Rain animation with wind effect
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('rain-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size to match window
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            // Initialize canvas size and handle resize
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Rain drop properties
            const raindrops = [];
            const maxDrops = 200; // Reduced for better performance
            
            // Wind properties
            let windForce = 0; // Current wind force
            let targetWindForce = 0; // Target wind force to animate to
            let windChangeTimer = 0; // Timer for wind changes
            
            // Create initial raindrops
            function createRaindrops() {
                for (let i = 0; i < maxDrops; i++) {
                    raindrops.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        length: Math.random() * 20 + 5, // Increased variation in length
                        speed: Math.random() * 20 + 10, // Increased speed range for more dynamic rain
                        thickness: Math.random() * 2 + 0.5, // Added minimum thickness
                        opacity: Math.random() * 0.5 + 0.2, // Adjusted opacity range
                        depth: Math.random() * 3 // Depth factor for parallax effect
                    });
                }
            }
            
            // Update wind force
            function updateWind() {
                windChangeTimer--;
                
                if (windChangeTimer <= 0) {
                    // Set a new target wind force
                    targetWindForce = Math.random() * 12 - 6; // Increased range: -6 to 6
                    windChangeTimer = Math.floor(Math.random() * 100) + 50; // 50 to 150 frames until next change
                }
                
                // Gradually change current wind force to approach target
                windForce += (targetWindForce - windForce) * 0.02; // Slightly faster wind change
            }
            
            // Update rain animation
            function updateRain() {
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Update wind
                updateWind();
                
                // Draw and update each raindrop
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.lineCap = 'round';
                
                for (let i = 0; i < raindrops.length; i++) {
                    const drop = raindrops[i];
                    
                    // Begin drawing raindrop
                    ctx.beginPath();
                    ctx.lineWidth = drop.thickness;
                    ctx.globalAlpha = drop.opacity;
                    
                    // Calculate wind effect based on depth (parallax)
                    const depthWindEffect = windForce * (drop.depth * 0.3);
                    
                    // Draw line from current position to calculated end position
                    ctx.moveTo(drop.x, drop.y);
                    ctx.lineTo(drop.x + depthWindEffect, drop.y + drop.length);
                    ctx.stroke();
                    
                    // Update position for next frame
                    drop.y += drop.speed * (drop.depth * 0.4 + 0.6); // Depth affects speed
                    drop.x += depthWindEffect * 0.6; // Apply wind effect with depth
                    
                    // Reset raindrop if it goes off screen
                    if (drop.y > canvas.height) {
                        drop.y = -drop.length * 2;
                        drop.x = Math.random() * canvas.width;
                    }
                    
                    // Reset raindrop if it goes off sides
                    if (drop.x < -50) drop.x = canvas.width + 50;
                    if (drop.x > canvas.width + 50) drop.x = -50;
                }
            }
            
            // Initialize raindrops
            createRaindrops();
            
            // Animation loop
            function animate() {
                updateRain();
                requestAnimationFrame(animate);
            }
            
            // Start animation
            animate();
            
            const mainScreen = document.getElementById('main-screen');
            const requestInput = document.getElementById('request-input');
            const usernameInput = document.getElementById('username-input');
            const sendButton = document.getElementById('send-button');
            const inputForm = document.getElementById('input-form');
            const primaryWrapper = document.getElementById('primary-wrapper');
            const secondaryWrapper = document.getElementById('secondary-wrapper');
            let requestDebounceTimer;
            let usernameDebounceTimer;
            let currentStage = 1;
            let inactivityTimer;
            let sessionCheckInterval; // Declare session check interval
            let userActivityTimeout; // For debouncing activity tracking
            let lastActivityTime = Date.now(); // Track the last activity time

            const adminToggleButton = document.getElementById('admin-toggle-button');
            const requestSection = document.querySelector('.request-section');

            // Anti-tamper notification panel
            const antiTamperNotificationPanel = document.createElement('div');
            antiTamperNotificationPanel.id = 'anti-tamper-notification-panel';
            antiTamperNotificationPanel.classList.add('anti-tamper-notification-panel');
            document.body.appendChild(antiTamperNotificationPanel);

            let antiTamperMessages = []; // Stores the anti-tamper messages
            let antiTamperPanelVisible = false; // Tracks the panel's open/closed state
            let notificationGlowActive = false; // Tracks if the admin button should glow
            let adminQuickButton; // Define adminQuickButton variable to prevent reference errors

            // Server ping to prevent Render from spinning down the app
            let keepAliveInterval;

            function startKeepAliveInterval() {
                // Clear any existing interval
                if (keepAliveInterval) {
                    clearInterval(keepAliveInterval);
                }
                
                // Send a ping to the server every 5 minutes
                keepAliveInterval = setInterval(async () => {
                    try {
                        // Simple ping request to keep the server active
                        const response = await fetch('/api/ping', {
                            method: 'GET',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        
                        console.log('Server ping sent to prevent idle shutdown');
                        
                        // If we can't reach the server, try to reload the page
                        if (!response.ok) {
                            console.warn('Server ping failed, attempting to reload in 30 seconds');
                            setTimeout(() => {
                                window.location.reload();
                            }, 30000);
                        }
                    } catch (error) {
                        console.warn('Failed to ping server:', error);
                        // If error, try to reload the page after 30 seconds
                        setTimeout(() => {
                            window.location.reload();
                        }, 30000);
                    }
                }, 5 * 60 * 1000); // Every 5 minutes
            }

            async function renderAntiTamperPanelMessages() {
                antiTamperNotificationPanel.innerHTML = ''; // Clear existing content

                const logs = await getAntiTamperLogs();
                antiTamperMessages = logs; // Store full log objects, not just messages

                if (antiTamperMessages.length === 0) {
                    antiTamperNotificationPanel.textContent = 'No active anti-tamper notifications.';
                    antiTamperNotificationPanel.style.justifyContent = 'center'; // Center text if empty
                    antiTamperNotificationPanel.style.alignItems = 'center';
                } else {
                    antiTamperNotificationPanel.style.justifyContent = 'flex-start'; // Revert to top alignment
                    antiTamperNotificationPanel.style.alignItems = 'flex-start';

                    antiTamperMessages.forEach((log) => { // Iterate over full log objects
                        const messageItem = document.createElement('div');
                        messageItem.classList.add('message-item');
                        messageItem.textContent = log.message; // Display message
                        messageItem.setAttribute('data-log-id', log.id); // Store log ID for deletion

                        const deleteButton = document.createElement('button');
                        deleteButton.classList.add('delete-anti-tamper-log-button');
                        deleteButton.textContent = 'x';
                        deleteButton.title = 'Clear this notification';
                        deleteButton.addEventListener('click', async (event) => {
                            event.stopPropagation(); // Prevent panel from closing

                            // IMMEDIATE VISUAL FEEDBACK: Remove the message from DOM
                            messageItem.remove();

                            // Optimistically update local array and button state
                            const indexToRemove = antiTamperMessages.findIndex(msg => msg.id === log.id);
                            if (indexToRemove !== -1) {
                                antiTamperMessages.splice(indexToRemove, 1);
                            }

                            // Update admin button glow/text if no messages left after local removal
                            if (antiTamperMessages.length === 0) {
                                adminToggleButton.textContent = '—';
                                adminToggleButton.classList.remove('notification-active');
                                notificationGlowActive = false;
                                // If the panel is open and becomes empty, display the "No active notifications" text
                                if (antiTamperPanelVisible) {
                                     antiTamperNotificationPanel.textContent = 'No active anti-tamper notifications.';
                                     antiTamperNotificationPanel.style.justifyContent = 'center';
                                     antiTamperNotificationPanel.style.alignItems = 'center';
                                }
                            }

                            await deleteAntiTamperLog(log.id); // Send delete request to server
                            // The server's socket emission will trigger setAntiTamperNotificationCallback,
                            // which will then call renderAntiTamperPanelMessages(),
                            // re-fetching logs and ensuring full consistency.
                            // We don't need to manually call renderAntiTamperPanelMessages() here after await,
                            // as the socket event handles the re-render.
                        });

                        messageItem.appendChild(deleteButton);
                        antiTamperNotificationPanel.appendChild(messageItem);
                    });
                }
            }

            // --- SESSION MANAGEMENT ---
            async function checkSessionAndRedirect() {
                // Überprüfen Sie zuerst auf Inaktivität
                const wasLoggedOut = checkInactivity();
                if (wasLoggedOut) {
                    return; // Wenn der Benutzer wegen Inaktivität ausgeloggt wurde, nichts weiter tun
                }
                
                const loggedInUser = getLoggedInUser();
                if (!loggedInUser) {
                    window.location.href = 'login.html';
                } else {
                    if (loggedInUser.idName === 'Amo') { // Assuming 'Amo' is the admin
                        adminToggleButton.classList.remove('hidden');
                        const logs = await getAntiTamperLogs();
                        if (logs.length > 0) {
                            adminToggleButton.textContent = '!';
                            adminToggleButton.classList.add('notification-active');
                            notificationGlowActive = true;
                        } else {
                            adminToggleButton.textContent = '—';
                            adminToggleButton.classList.remove('notification-active');
                            notificationGlowActive = false;
                        }
                    } else {
                        adminToggleButton.classList.add('hidden');
                    }
                    
                    // Nur die Socket-Registrierung durchführen, NICHT den Timestamp aktualisieren
                    registerSessionWithServer({
                        securityId: loggedInUser.securityId || 'unknown',
                        username: loggedInUser.username || loggedInUser.idName,
                        idName: loggedInUser.idName,
                        designType: loggedInUser.designType
                    });
                }
            }

            // Initial session check on page load
            checkSessionAndRedirect();

            // Set up a periodic session check (e.g., every minute)
            sessionCheckInterval = setInterval(checkSessionAndRedirect, 60 * 1000); // Check every 1 minute
            
            // Start keep alive interval to prevent Render from spinning down the app
            startKeepAliveInterval();
            
            // Set up a strict inactivity check every 10 seconds
            const inactivityCheckInterval = setInterval(() => {
                // Import checkInactivity from db.js
                const wasLoggedOut = checkInactivity();
                if (wasLoggedOut) {
                    // If the user was logged out, clear all intervals
                    clearInterval(sessionCheckInterval);
                    clearInterval(inactivityCheckInterval);
                    clearInterval(keepAliveInterval);
                }
            }, 10 * 1000); // Check every 10 seconds
            
            // Debounced user activity tracking to reduce performance impact
            function trackUserActivity() {
                // Update the last activity time
                lastActivityTime = Date.now();
                
                // Clear any existing timeout
                if (userActivityTimeout) {
                    clearTimeout(userActivityTimeout);
                }
                
                // Reset inactivity timer immediately to prevent timeout issues
                resetInactivityTimer();
                
                // Debounce the activity timestamp update to once every 10 seconds at most
                userActivityTimeout = setTimeout(() => {
                    const loggedInUser = getLoggedInUser();
                    if (loggedInUser) {
                        // Only update timestamp if user is logged in
                        setLoggedInUser(loggedInUser);
                        console.log("User activity detected, session timeout reset");
                    }
                }, 10000); // Debounce for 10 seconds
            }
            
            // Inactivity timer for auto logout
            let inactivityTimeout;
            let warningTimeout;
            
            function resetInactivityTimer() {
                // Clear any existing timers
                if (inactivityTimeout) {
                    clearTimeout(inactivityTimeout);
                }
                if (warningTimeout) {
                    clearTimeout(warningTimeout);
                }
                
                // Hide any existing warning
                const warningEl = document.getElementById('session-timeout-warning');
                if (warningEl) {
                    document.body.removeChild(warningEl);
                }
                
                // Set warning timer for 2 minutes (1 minute before logout)
                warningTimeout = setTimeout(() => {
                    showSessionWarning();
                }, 2 * 60 * 1000);
                
                // Set new timer for 3 minutes
                inactivityTimeout = setTimeout(() => {
                    const loggedInUser = getLoggedInUser();
                    if (loggedInUser) {
                        console.log('Session timeout: Logging out due to inactivity');
                        logoutUser();
                        window.location.href = 'login.html?reason=inactivity_timeout';
                    }
                }, 3 * 60 * 1000); // 3 minutes
            }
            
            function showSessionWarning() {
                // Create warning element if it doesn't exist
                if (!document.getElementById('session-timeout-warning')) {
                    const warningEl = document.createElement('div');
                    warningEl.id = 'session-timeout-warning';
                    warningEl.style.position = 'fixed';
                    warningEl.style.top = '20px';
                    warningEl.style.left = '50%';
                    warningEl.style.transform = 'translateX(-50%)';
                    warningEl.style.padding = '15px 25px';
                    warningEl.style.background = 'rgba(255, 77, 77, 0.9)';
                    warningEl.style.color = 'white';
                    warningEl.style.borderRadius = '8px';
                    warningEl.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.3)';
                    warningEl.style.zIndex = '9999';
                    warningEl.style.fontWeight = 'bold';
                    warningEl.style.textAlign = 'center';
                    warningEl.style.animation = 'fadeIn 0.5s ease-in-out';
                    warningEl.innerHTML = 'Your session will expire in 60s!<br>Please interact with the page to stay logged in.';
                    
                    document.body.appendChild(warningEl);
                    
                    // Add click event to reset timer when user clicks on warning
                    warningEl.addEventListener('click', () => {
                        trackUserActivity();
                    });
                }
            }
            
            // Initialize inactivity timer on page load if user is logged in
            const loggedInUser = getLoggedInUser();
            if (loggedInUser) {
                resetInactivityTimer();
            }
            
            // Add event listeners with throttling for better performance
            // Use passive event listeners where possible for better performance
            document.addEventListener('mousemove', function() {
                // Only track activity if more than 2 seconds have passed since the last track
                if (Date.now() - lastActivityTime > 2000) {
                    trackUserActivity();
                }
            }, { passive: true });
            
            // These events are less frequent, so we can track them every time
            document.addEventListener('keypress', trackUserActivity, { passive: true });
            document.addEventListener('click', trackUserActivity, { passive: true });
            document.addEventListener('scroll', function() {
                // Only track activity if more than 2 seconds have passed since the last track
                if (Date.now() - lastActivityTime > 2000) {
                    trackUserActivity();
                }
            }, { passive: true });
            document.addEventListener('touchstart', trackUserActivity, { passive: true });

            // Add more interaction events to ensure all user activity is captured
            document.addEventListener('keydown', trackUserActivity, { passive: true });
            document.addEventListener('mousedown', trackUserActivity, { passive: true });
            document.addEventListener('touchmove', function() {
                if (Date.now() - lastActivityTime > 2000) {
                    trackUserActivity();
                }
            }, { passive: true });

            // Admin button click to toggle anti-tamper panel
            adminToggleButton.addEventListener('click', () => {
                antiTamperPanelVisible = !antiTamperPanelVisible;
                if (antiTamperPanelVisible) {
                    antiTamperNotificationPanel.classList.add('visible');
                    renderAntiTamperPanelMessages(); // Render messages when panel is opened
                    // If panel is opened and there were new notifications, acknowledge them
                    if (notificationGlowActive) {
                        adminToggleButton.textContent = '—'; // Reset button text
                        adminToggleButton.classList.remove('notification-active'); // Remove glow
                        notificationGlowActive = false;
                    }
                } else {
                    antiTamperNotificationPanel.classList.remove('visible');
                }
            });

            // Callback for new anti-tamper notifications
            setAntiTamperNotificationCallback((log) => {
                // `log` here is the new log object from the server, or undefined if logs cleared
                if (log) {
                    // If it's a new log (not a clear all event), push it
                    if (log.id && log.message) {
                         // Check if the log already exists to prevent duplicates on re-render
                        const exists = antiTamperMessages.some(existingLog => existingLog.id === log.id);
                        if (!exists) {
                            antiTamperMessages.unshift(log); // Add new message to local array, unshift to keep newest at top
                        }
                    }
                } else {
                    antiTamperMessages = []; // If log is undefined, it means logs were cleared or refreshed
                }
                renderAntiTamperPanelMessages(); // Re-render the panel with updated messages

                if (!antiTamperPanelVisible && antiTamperMessages.length > 0) { // Only make button glow if panel is not open and there are messages
                    adminToggleButton.textContent = '!';
                    adminToggleButton.classList.add('notification-active');
                    notificationGlowActive = true;
                } else if (antiTamperMessages.length === 0) { // If no messages, ensure button is not glowing
                    adminToggleButton.textContent = '—';
                    adminToggleButton.classList.remove('notification-active');
                    notificationGlowActive = false;
                }
            });

            // --- SMOOTH SCROLL CAROUSEL ---
            const galleryContent = document.querySelector('.gallery-content');
            let albumWrappers = Array.from(galleryContent.querySelectorAll('.album-item-wrapper'));
            let current = 2; // Start with Album 5 (Index 4)
            let albumItems = []; // Store album items from database
            
            // Drag scrolling variables
            const galleryContainer = document.querySelector('.gallery-container');
            let isDragging = false;
            let startX, startY;
            let dragStartTime;
            let lastDragX = 0;
            let dragDistance = 0;
            let dragDirection = 0;
            let dragAnimationFrame = null;
            let dragThreshold = 80; // Verbesserte Empfindlichkeit
            let endDragThreshold = 50; // Verbesserte Empfindlichkeit
            
            // Add drag scroll functionality
            galleryContainer.addEventListener('mousedown', (e) => {
                isDragging = true;
                startX = e.pageX;
                startY = e.pageY;
                dragStartTime = Date.now();
                lastDragX = startX;
                dragDistance = 0;
                
                // Change cursor style
                galleryContainer.style.cursor = 'grabbing';
                galleryContainer.classList.add('dragging');
                
                // Clear any existing animations
                if (dragAnimationFrame) {
                    cancelAnimationFrame(dragAnimationFrame);
                }
                
                // Prevent default text selection behavior
                e.preventDefault();
            });
            
            galleryContainer.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                // Calculate horizontal drag distance
                const currentX = e.pageX;
                const deltaX = currentX - lastDragX;
                lastDragX = currentX;
                
                // Accumulate drag distance to determine direction and magnitude
                dragDistance += deltaX;
                
                // Determine drag direction
                dragDirection = Math.sign(dragDistance);
                
                // If dragged far enough, trigger slide
                if (Math.abs(dragDistance) > dragThreshold) {
                    // Move carousel in the opposite direction of drag
                    const targetSlide = current - dragDirection;
                    goto(targetSlide);
                    
                    // Reset drag distance after triggering slide
                    dragDistance = 0;
                } else {
                    // Apply live drag transform for immediate feedback
                    const activeWrapper = albumWrappers[current];
                    if (activeWrapper) {
                        const currentTransform = getCurrentTransformX(galleryContent);
                        galleryContent.style.transform = `translateX(${currentTransform + deltaX}px)`;
                    }
                }
                
                // Reset carousel timer on manual drag
                resetCarouselTimer();
                
                // Prevent default actions that may interfere
                e.preventDefault();
            });
            
            galleryContainer.addEventListener('mouseup', endDrag);
            galleryContainer.addEventListener('mouseleave', endDrag);
            
            function endDrag(e) {
                if (!isDragging) return;
                isDragging = false;
                
                // Reset cursor
                galleryContainer.style.cursor = 'grab';
                galleryContainer.classList.remove('dragging');
                
                // Process final slide based on drag distance and direction
                if (Math.abs(dragDistance) > endDragThreshold) {
                    // Move carousel in the opposite direction of drag
                    const targetSlide = current - dragDirection;
                    goto(targetSlide);
                } else {
                    // Snap back to center position if drag wasn't far enough
                    centerCurrentAlbum();
                }
                
                // Reset variables
                dragDistance = 0;
                
                // Reset carousel timer
                resetCarouselTimer();
            }
            
            // Helper function to get the current translateX value
            function getCurrentTransformX(element) {
                const style = window.getComputedStyle(element);
                const matrix = new DOMMatrixReadOnly(style.transform);
                return matrix.m41; // The translateX value from the transform matrix
            }

            // Add touch support for mobile
            galleryContainer.addEventListener('touchstart', (e) => {
                isDragging = true;
                startX = e.touches[0].pageX;
                startY = e.touches[0].pageY;
                dragStartTime = Date.now();
                lastDragX = startX;
                dragDistance = 0;
                
                // Add dragging class
                galleryContainer.classList.add('dragging');
                
                // Clear any existing animations
                if (dragAnimationFrame) {
                    cancelAnimationFrame(dragAnimationFrame);
                }
            }, { passive: true });
            
            galleryContainer.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                
                // Calculate horizontal drag distance
                const currentX = e.touches[0].pageX;
                const deltaX = currentX - lastDragX;
                lastDragX = currentX;
                
                // Accumulate drag distance to determine direction and magnitude
                dragDistance += deltaX;
                
                // Determine drag direction
                dragDirection = Math.sign(dragDistance);
                
                // If dragged far enough, trigger slide
                if (Math.abs(dragDistance) > dragThreshold) {
                    // Move carousel in the opposite direction of drag
                    const targetSlide = current - dragDirection;
                    goto(targetSlide);
                    
                    // Reset drag distance after triggering slide
                    dragDistance = 0;
                } else {
                    // Apply live drag transform for immediate feedback
                    const activeWrapper = albumWrappers[current];
                    if (activeWrapper) {
                        const currentTransform = getCurrentTransformX(galleryContent);
                        galleryContent.style.transform = `translateX(${currentTransform + deltaX}px)`;
                    }
                }
                
                // Reset carousel timer on manual touch drag
                resetCarouselTimer();
            }, { passive: true });
            
            galleryContainer.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                
                // Remove dragging class
                galleryContainer.classList.remove('dragging');
                
                // Process final slide based on drag distance and direction
                if (Math.abs(dragDistance) > endDragThreshold) {
                    // Move carousel in the opposite direction of drag
                    const targetSlide = current - dragDirection;
                    goto(targetSlide);
                } else {
                    // Snap back to center position if drag wasn't far enough
                    centerCurrentAlbum();
                }
                
                // Reset variables
                dragDistance = 0;
                
                
                // Reset carousel timer
                resetCarouselTimer();
            });

            function centerCurrentAlbum() {
                const activeWrapper = albumWrappers[current];
                if (!activeWrapper) return;
                
                // Calculate transform to center the current album
                const albumWidth = activeWrapper.offsetWidth;
                const containerWidth = galleryContainer.offsetWidth;
                const centerOffset = (containerWidth - albumWidth) / 2;
                
                // Get position of active album
                const wrapperLeft = activeWrapper.offsetLeft;
                
                // Calculate the exact position needed for perfect centering
                let targetPosition = wrapperLeft - centerOffset;
                
                // Ensure we don't go beyond bounds
                const maxScroll = galleryContent.scrollWidth - containerWidth;
                targetPosition = Math.max(0, Math.min(targetPosition, maxScroll));
                
                // Apply transform animation with smooth easing
                galleryContent.style.transform = `translateX(-${targetPosition}px)`;
            }
            
            // Initialize carousel and center it
            albumWrappers[4].querySelector('.placeholder-image').classList.add('active');
            albumWrappers[3].querySelector('.placeholder-image').classList.add('left1');
            albumWrappers[2].querySelector('.placeholder-image').classList.add('left2');
            albumWrappers[5].querySelector('.placeholder-image').classList.add('right1');
            albumWrappers[6].querySelector('.placeholder-image').classList.add('right2');
            
            // Make sure DOM is fully ready for accurate measurements
            setTimeout(() => {
                // Ensure initial centering on load
                centerCurrentAlbum();
            }, 100);

            function resetCarouselTimer() {
                clearTimeout(inactivityTimer);
                inactivityTimer = setTimeout(() => {
                    goto(2);
                }, 5000);
            }

            async function renderAlbums() {
                try {
                    // Fetch album items from server
                    console.log('Fetching');
                    albumItems = await getAlbumItems();
                    console.log('Received');
                    
                    // Ensure albumItems is always an array
                    if (!Array.isArray(albumItems)) {
                        console.warn('Empty');
                        albumItems = [];
                    }
                    
                    // Sort by timestamp descending (newest first) if timestamp exists
                    albumItems.sort((a, b) => {
                        if (a.timestamp && b.timestamp) {
                            return b.timestamp - a.timestamp;
                        }
                        return 0;
                    });
                    
                    // Limit to 10 items for the carousel
                    const displayItems = albumItems.slice(0, 10);
                    
                    // Get all existing album wrappers
                    const albumWrappers = Array.from(galleryContent.querySelectorAll('.album-item-wrapper'));
                    console.log('Loaded');
                    
                    // Update existing album elements with data from displayItems
                    albumWrappers.forEach((wrapper, i) => {
                        try {
                            const placeholderImage = wrapper.querySelector('.placeholder-image');
                            const albumNameDiv = wrapper.querySelector('.album-name');
                            
                            if (!placeholderImage || !albumNameDiv) {
                                console.warn('Missing');
                                return; // Skip this iteration
                            }
                            
                            if (i < displayItems.length) {
                                // We have data for this album position
                                const item = displayItems[i];
                                
                                // Update album name
                                albumNameDiv.textContent = item.name || `Album Name ${i + 1}`;
                                
                                // Clear any existing content in the placeholder image
                                placeholderImage.innerHTML = '';
                                
                                // Update the image if available
                                if (item.imageUrl && item.imageUrl.trim() !== '') {
                                    placeholderImage.style.backgroundImage = `url(${item.imageUrl})`;
                                    placeholderImage.style.backgroundSize = 'cover';
                                    placeholderImage.style.backgroundPosition = 'center';
                                } else {
                                    // No image URL, show placeholder text
                                    const placeholderText = document.createElement('div');
                                    placeholderText.classList.add('placeholder-text');
                                    placeholderText.textContent = `G ${i + 1}`;
                                    placeholderImage.appendChild(placeholderText);
                                    placeholderImage.style.backgroundImage = '';
                                }
                            } else {
                                // No data for this position, set default
                                albumNameDiv.textContent = `G Name ${i + 1}`;
                                placeholderImage.innerHTML = '';
                                placeholderImage.style.backgroundImage = '';
                                const placeholderText = document.createElement('div');
                                placeholderText.classList.add('placeholder-text');
                                placeholderText.textContent = `G ${i + 1}`;
                                placeholderImage.appendChild(placeholderText);
                            }
                        } catch (itemErr) {
                            console.error('Error');
                        }
                    });
                    
                    // Ensure album event listeners
                    console.log('Init');
                    initializeAlbumEventListeners();
                    
                    // Ensure carousel is set up correctly
                    current = 2; // Always start with Album 5 (index 4) as active
                    console.log('Update');
                    updateCarousel();
            resetCarouselTimer();

                    console.log('Success');
                } catch (error) {
                    console.error('Failed');
                    
                    // Ensure we have default album visuals even if everything fails
                    try {
                        const albumWrappers = Array.from(galleryContent.querySelectorAll('.album-item-wrapper'));
                        
                        if (albumWrappers.length > 0) {
            albumWrappers.forEach((wrapper, i) => {
                                const placeholderImage = wrapper.querySelector('.placeholder-image');
                                if (placeholderImage) {
                                    placeholderImage.innerHTML = '';
                                    const placeholderText = document.createElement('div');
                                    placeholderText.classList.add('placeholder-text');
                                    placeholderText.textContent = `G ${i + 1}`;
                                    placeholderImage.appendChild(placeholderText);
                                }
                            });
                            current = 2;
                            updateCarousel();
                        }
                    } catch (fallbackError) {
                        console.error('Fallback');
                    }
                }
            }
            
            function initializeAlbumEventListeners() {
                // Update album wrappers reference after re-rendering
                albumWrappers = Array.from(galleryContent.querySelectorAll('.album-item-wrapper'));

            albumWrappers.forEach((wrapper, i) => {
                    // Remove existing click listeners to prevent duplicates
                    const newWrapper = wrapper.cloneNode(true);
                    wrapper.parentNode.replaceChild(newWrapper, wrapper);
                    albumWrappers[i] = newWrapper;
                    
                    newWrapper.addEventListener('click', () => {
                    if (i !== current) {
                        goto(i);
                    }
                        
                        const detail = i < albumItems.length ? albumItems[i] : {
                            name: `G Name ${i+1}`,
                            acc: 'Empty',
                            pw: 'Empty',
                            imageUrl: ''
                        };
                        
                        modalAlbumName.textContent = detail.name;

                        if (detail.acc && detail.acc !== 'Empty') {
                            copyAccButton.textContent = `Copy ACC`;
                            copyAccButton.setAttribute('data-clipboard-text', detail.acc);
                            copyAccButton.classList.remove('is-empty');
                            copyAccButton.style.cursor = 'pointer';
                        } else {
                            copyAccButton.textContent = `Empty`;
                            copyAccButton.setAttribute('data-clipboard-text', 'Empty');
                            copyAccButton.classList.add('is-empty');
                            copyAccButton.style.cursor = 'not-allowed';
                        }
                        copyAccButton.classList.add('gradient-animated');

                        if (detail.pw && detail.pw !== 'Empty') {
                            copyPwButton.textContent = `Copy PW`;
                            copyPwButton.setAttribute('data-clipboard-text', detail.pw);
                            copyPwButton.classList.remove('is-empty');
                            copyPwButton.style.cursor = 'pointer';
                        } else {
                            copyPwButton.textContent = `Empty`;
                            copyPwButton.setAttribute('data-clipboard-text', 'Empty');
                            copyPwButton.classList.add('is-empty');
                            copyPwButton.style.cursor = 'not-allowed';
                        }
                        copyPwButton.classList.add('gradient-animated');

                        // Update modal image if available
                        const modalImage = albumDetailModal.querySelector('.modal-image-placeholder');
                        if (detail.imageUrl && detail.imageUrl.trim() !== '') {
                            modalImage.style.backgroundImage = `url(${detail.imageUrl})`;
                            modalImage.style.backgroundSize = 'cover';
                            modalImage.style.backgroundPosition = 'center';
                            modalImage.textContent = '';
                        } else {
                            modalImage.style.backgroundImage = 'none';
                            modalImage.textContent = 'No Image Available';
                        }

                        // Add edit/delete buttons for admin mode
                        const modalEditOptions = albumDetailModal.querySelector('.modal-edit-options');
                        if (modalEditOptions) {
                            const isAdminMode = requestSection.classList.contains('admin-mode');
                            modalEditOptions.style.display = isAdminMode ? 'flex' : 'none';
                            
                            // Set data attributes for editing even for default albums
                            modalEditOptions.setAttribute('data-album-id', detail.id || '');
                            modalEditOptions.setAttribute('data-album-name', detail.name || `Album Name ${i+1}`);
                            modalEditOptions.setAttribute('data-album-imageurl', detail.imageUrl || '');
                            modalEditOptions.setAttribute('data-album-acc', detail.acc || 'Empty');
                            modalEditOptions.setAttribute('data-album-pw', detail.pw || 'Empty');
                }

                        albumDetailModalOverlay.classList.add('visible');
                    });
                    
                    // Re-establish hover effects for the carousel
                    newWrapper.addEventListener('mouseenter', () => {
                    hoverTarget = i;
                    if (hoverStepTimeout) clearTimeout(hoverStepTimeout);
                    if (hoverStepInterval) clearInterval(hoverStepInterval);
                    if (Math.abs(i - current) > 1) {
                        hoverStepTimeout = setTimeout(() => {
                            stepToTarget();
                            hoverStepInterval = setInterval(() => {
                                stepToTarget();
                            }, 500);
                        }, 1000);
                    }
                });
                    
                    newWrapper.addEventListener('mouseleave', () => {
                    hoverTarget = null;
                    if (hoverStepTimeout) clearTimeout(hoverStepTimeout);
                    if (hoverStepInterval) clearInterval(hoverStepInterval);
                });
            });
            }

            function updateCarousel() {
                // Remove all visual classes
                albumWrappers.forEach(wrapper => {
                    const albumImage = wrapper.querySelector('.placeholder-image');
                    albumImage.classList.remove('active', 'left1', 'left2', 'right1', 'right2');
                    wrapper.classList.remove('is-visible');
                });
                
                // Apply new classes with calculated indexes to ensure proper display
                albumWrappers.forEach((wrapper, i) => {
                    const albumImage = wrapper.querySelector('.placeholder-image');
                    let shouldBeVisible = false;

                    if (i === current) {
                        albumImage.classList.add('active');
                        shouldBeVisible = true;
                    } else if (i === current - 1) {
                        albumImage.classList.add('left1');
                        shouldBeVisible = true;
                    } else if (i === current - 2) {
                        albumImage.classList.add('left2');
                        shouldBeVisible = true;
                    } else if (i === current + 1) {
                        albumImage.classList.add('right1');
                        shouldBeVisible = true;
                    } else if (i === current + 2) {
                        albumImage.classList.add('right2');
                        shouldBeVisible = true;
                    }
                    if (shouldBeVisible) {
                        wrapper.classList.add('is-visible');
                    }
                });
                
                // Apply transform animation to center the current album
                centerCurrentAlbum();
            }
            
            function centerCurrentAlbum() {
                const activeWrapper = albumWrappers[current];
                if (!activeWrapper) return;
                
                // Calculate transform to center the current album
                const albumWidth = activeWrapper.offsetWidth;
                const containerWidth = galleryContainer.offsetWidth;
                const centerOffset = (containerWidth - albumWidth) / 2;
                
                // Get position of active album
                const wrapperLeft = activeWrapper.offsetLeft;
                
                // Calculate the exact position needed for perfect centering
                let targetPosition = wrapperLeft - centerOffset;
                
                // Ensure we don't go beyond bounds
                const maxScroll = galleryContent.scrollWidth - containerWidth;
                targetPosition = Math.max(0, Math.min(targetPosition, maxScroll));
                
                // Apply transform animation with smooth easing
                galleryContent.style.transform = `translateX(-${targetPosition}px)`;
            }

            function goto(idx) {
                if (idx < 0) idx = 0;
                if (idx >= albumWrappers.length) idx = albumWrappers.length - 1;
                
                // Only update if changing to a different position
                if (current !== idx) {
                    current = idx;
                    updateCarousel();
                }
                
                resetCarouselTimer();
            }

            galleryContent.addEventListener('wheel', resetCarouselTimer);
            galleryContent.addEventListener('mousedown', resetCarouselTimer);
            galleryContent.addEventListener('mousemove', resetCarouselTimer);
            galleryContent.addEventListener('mouseup', resetCarouselTimer);
            galleryContent.addEventListener('mouseleave', resetCarouselTimer);
            galleryContent.addEventListener('touchstart', resetCarouselTimer);
            galleryContent.addEventListener('touchmove', resetCarouselTimer);
            galleryContent.addEventListener('touchend', resetCarouselTimer);
            
            function handleRequestInput() {
                const requestValue = requestInput.value.trim();
                clearTimeout(requestDebounceTimer);
                if (requestValue && currentStage === 1) {
                    requestDebounceTimer = setTimeout(() => {
                        currentStage = 2;
                        inputForm.classList.add('shifted');
                        primaryWrapper.classList.add('shifted');
                        setTimeout(() => {
                            secondaryWrapper.classList.add('visible');
                        }, 400);
                    }, 1000);
                } else if (!requestValue && currentStage > 1) {
                    currentStage = 1;
                    inputForm.classList.remove('shifted');
                    primaryWrapper.classList.remove('shifted');
                    secondaryWrapper.classList.remove('visible');
                    sendButton.classList.remove('visible');
                    usernameInput.value = '';
                    clearTimeout(usernameDebounceTimer);
                }
            }
            function handleUsernameInput() {
                const requestValue = requestInput.value.trim();
                const usernameValue = usernameInput.value.trim();
                clearTimeout(usernameDebounceTimer);
                if (requestValue && usernameValue && currentStage === 2) {
                    usernameDebounceTimer = setTimeout(() => {
                        currentStage = 3;
                         sendButton.classList.add('visible');
                    }, 1000);
                } else if ((!requestValue || !usernameValue) && currentStage === 3) {
                    currentStage = 2;
                    sendButton.classList.remove('visible');
                }
            }
            requestInput.addEventListener('input', handleRequestInput);
            usernameInput.addEventListener('input', handleUsernameInput);
            sendButton.addEventListener('click', async () => {
                const requestText = requestInput.value.trim();
                const username = usernameInput.value.trim();

                const loggedInUser = getLoggedInUser();

                if (!loggedInUser) {
                    alert('Please log in with a Security ID first.');
                    sendButton.classList.remove('launching');
                    return;
                }

                if (!requestText || !username) {
                    alert('Please enter both a request and a username.');
                    sendButton.classList.remove('launching');
                    return;
                }

                sendButton.classList.add('launching');

                setTimeout(async () => {
                    await addRequest({ username, text: requestText, designType: loggedInUser.designType, idName: loggedInUser.idName });

                    requestInput.value = '';
                    usernameInput.value = '';
                    currentStage = 1;
                    inputForm.classList.remove('shifted');
                    primaryWrapper.classList.remove('shifted');
                    secondaryWrapper.classList.remove('visible');
                    sendButton.classList.remove('visible', 'launching');
                }, 1200);
            });

            const searchBar = document.querySelector('.search-bar');
            if (searchBar) {
                // Create a custom clear button
                const clearButton = document.createElement('button');
                clearButton.type = 'button';
                clearButton.className = 'search-clear-button';
                clearButton.textContent = 'x';
                clearButton.style.position = 'absolute';
                clearButton.style.right = '15px';
                clearButton.style.top = '50%';
                clearButton.style.transform = 'translateY(-50%)';
                clearButton.style.background = 'none';
                clearButton.style.border = 'none';
                clearButton.style.color = 'white';
                clearButton.style.width = '20px';
                clearButton.style.height = '20px';
                clearButton.style.borderRadius = '50%';
                clearButton.style.fontSize = '12px';
                clearButton.style.fontWeight = 'bold';
                clearButton.style.cursor = 'pointer';
                clearButton.style.display = 'none';
                clearButton.style.alignItems = 'center';
                clearButton.style.justifyContent = 'center';
                clearButton.style.zIndex = '5';
                clearButton.style.padding = '0';
                
                // Add the clear button to the search wrapper
                const searchWrapper = document.querySelector('.search-wrapper');
                searchWrapper.appendChild(clearButton);
                
                // Show/hide clear button based on input
                searchBar.addEventListener('input', () => {
                    const searchValue = searchBar.value.trim().toLowerCase();
                    if (searchValue.length > 0) {
                        searchBar.classList.add('has-value');
                        clearButton.style.display = 'flex';
                        searchAlbums(searchValue);
                    } else {
                        searchBar.classList.remove('has-value');
                        clearButton.style.display = 'none';
                        clearSearchResults();
                    }
                });
                
                // Clear search when button is clicked
                clearButton.addEventListener('click', () => {
                    searchBar.value = '';
                    searchBar.classList.remove('has-value');
                    clearButton.style.display = 'none';
                    clearSearchResults();
                    searchBar.focus();
                });
                
                // Add listener for search box reset button click
                searchBar.addEventListener('search', () => {
                    if (searchBar.value.trim() === '') {
                        searchBar.classList.remove('has-value');
                        clearButton.style.display = 'none';
                        clearSearchResults();
                    }
                });
            }

            // Search albums function
            function searchAlbums(query) {
                const searchResultsList = document.querySelector('.search-results-list');
                searchResultsList.innerHTML = ''; // Clear previous results
                
                if (!albumItems || albumItems.length === 0) {
                    // No albums available
                    const noResultsItem = document.createElement('div');
                    noResultsItem.classList.add('search-result-item');
                    noResultsItem.textContent = '• No albums available';
                    noResultsItem.style.textAlign = 'center';
                    searchResultsList.appendChild(noResultsItem);
                    return;
                }
                
                // Filter albums by name containing the query
                const matchingAlbums = albumItems.filter(album => 
                    album.name && album.name.toLowerCase().includes(query)
                );
                
                if (matchingAlbums.length === 0) {
                    // No matching albums
                    const noResultsItem = document.createElement('div');
                    noResultsItem.classList.add('search-result-item');
                    noResultsItem.textContent = '• No matching albums';
                    noResultsItem.style.textAlign = 'center';
                    searchResultsList.appendChild(noResultsItem);
                    return;
                }
                
                // Display all matching albums (scrolling will handle overflow)
                matchingAlbums.forEach(album => {
                    const resultItem = document.createElement('div');
                    resultItem.classList.add('search-result-item', 'clickable');
                    resultItem.textContent = `• ${album.name}`;
                    
                    // Add click event to show album details
                    resultItem.addEventListener('click', () => {
                        showAlbumDetails(album);
                    });
                    
                    searchResultsList.appendChild(resultItem);
                });
                
                // No need for dynamic height calculation since we're scrolling
            }
            
            // Clear search results function
            function clearSearchResults() {
                const searchResultsList = document.querySelector('.search-results-list');
                searchResultsList.innerHTML = ''; // Just clear the list without adding a placeholder
            }
            
            // Function to show album details when clicking a search result
            function showAlbumDetails(album) {
                // Use existing album detail display logic
                modalAlbumName.textContent = album.name;
                
                // Set ACC button
                if (album.acc && album.acc !== 'Empty') {
                    copyAccButton.textContent = 'Copy ACC';
                    copyAccButton.setAttribute('data-clipboard-text', album.acc);
                    copyAccButton.classList.remove('is-empty');
                    copyAccButton.style.cursor = 'pointer';
                } else {
                    copyAccButton.textContent = 'Empty';
                    copyAccButton.setAttribute('data-clipboard-text', 'Empty');
                    copyAccButton.classList.add('is-empty');
                    copyAccButton.style.cursor = 'not-allowed';
                }
                copyAccButton.classList.add('gradient-animated');
                
                // Set PW button
                if (album.pw && album.pw !== 'Empty') {
                    copyPwButton.textContent = 'Copy PW';
                    copyPwButton.setAttribute('data-clipboard-text', album.pw);
                    copyPwButton.classList.remove('is-empty');
                    copyPwButton.style.cursor = 'pointer';
                } else {
                    copyPwButton.textContent = 'Empty';
                    copyPwButton.setAttribute('data-clipboard-text', 'Empty');
                    copyPwButton.classList.add('is-empty');
                    copyPwButton.style.cursor = 'not-allowed';
                }
                copyPwButton.classList.add('gradient-animated');
                
                // Update modal image if available
                const modalImage = albumDetailModal.querySelector('.modal-image-placeholder');
                if (album.imageUrl && album.imageUrl.trim() !== '') {
                    modalImage.style.backgroundImage = `url(${album.imageUrl})`;
                    modalImage.style.backgroundSize = 'cover';
                    modalImage.style.backgroundPosition = 'center';
                    modalImage.textContent = '';
                } else {
                    modalImage.style.backgroundImage = 'none';
                    modalImage.textContent = 'No Image Available';
                }
                
                // Set up edit/delete options for admin mode
                const modalEditOptions = albumDetailModal.querySelector('.modal-edit-options');
                if (modalEditOptions) {
                    const isAdminMode = requestSection.classList.contains('admin-mode');
                    modalEditOptions.style.display = isAdminMode ? 'flex' : 'none';
                    
                    modalEditOptions.setAttribute('data-album-id', album.id || '');
                    modalEditOptions.setAttribute('data-album-name', album.name || '');
                    modalEditOptions.setAttribute('data-album-imageurl', album.imageUrl || '');
                    modalEditOptions.setAttribute('data-album-acc', album.acc || 'Empty');
                    modalEditOptions.setAttribute('data-album-pw', album.pw || 'Empty');
                }
                
                // Close search results and show album detail modal
                searchBar.value = '';
                searchBar.classList.remove('has-value');
                clearSearchResults();
                albumDetailModalOverlay.classList.add('visible');
            }

            const idNameTooltip = document.createElement('div');
            idNameTooltip.id = 'id-name-tooltip';
            document.body.appendChild(idNameTooltip);

            function setupHoverEffects() {
                document.querySelectorAll('.request-username').forEach(usernameEl => {
                    usernameEl.addEventListener('mouseover', (e) => {
                        const idName = usernameEl.getAttribute('data-id-name');
                        if (idName) {
                            idNameTooltip.textContent = idName;
                            idNameTooltip.style.left = `${e.pageX + 15}px`;
                            idNameTooltip.style.top = `${e.pageY - 20}px`;
                            idNameTooltip.style.opacity = '1';
                            idNameTooltip.style.visibility = 'visible';
                        }
                    });
                    usernameEl.addEventListener('mouseout', () => {
                        idNameTooltip.style.opacity = '0';
                        idNameTooltip.style.visibility = 'hidden';
                    });
                });
            }

            setupHoverEffects();

            const originalSendButtonClick = sendButton.onclick;
            sendButton.onclick = (event) => {
                setTimeout(() => {
                    setupHoverEffects();
                }, 1200);
            };

            adminToggleButton.addEventListener('click', () => {
                requestSection.classList.toggle('admin-mode');
                const isAdminMode = requestSection.classList.contains('admin-mode');
                toggleAdminView(isAdminMode);
            });

            function toggleAdminView(isAdminMode) {
                const requestsList = document.querySelector('.requests-list');
                const requestItems = requestsList.querySelectorAll('.request-item:not(#initial-request-placeholder)');

                if (isAdminMode) {
                    // Requests management
                    requestItems.forEach(item => {
                        if (!item.querySelector('.delete-request-button')) {
                            const deleteButton = document.createElement('button');
                            deleteButton.classList.add('delete-request-button');
                            deleteButton.textContent = 'x';
                            item.appendChild(deleteButton);

                            deleteButton.addEventListener('click', async (event) => {
                                event.stopPropagation(); 
                                const requestId = item.getAttribute('data-request-id');
                                await deleteRequest(requestId);
                            });
                        }
                    });
                    
                    // Album management - add "Add Album" button to the gallery container if not exists
                    const galleryContainer = document.querySelector('.gallery-container');
                    if (!document.getElementById('add-album-button')) {
                        const addAlbumButton = document.createElement('button');
                        addAlbumButton.id = 'add-album-button';
                        addAlbumButton.className = 'glassy-button gradient-animated';
                        addAlbumButton.style.position = 'absolute';
                        addAlbumButton.style.right = '20px';
                        addAlbumButton.style.top = '10px';
                        addAlbumButton.style.zIndex = '10';
                        addAlbumButton.textContent = '+ Add Album';
                        
                        addAlbumButton.addEventListener('click', () => {
                            // Clear form
                            editAlbumId.value = '';
                            editAlbumName.value = '';
                            editAlbumImageUrl.value = '';
                            editAlbumAcc.value = '';
                            editAlbumPw.value = '';
                            
                            // Set form title
                            albumEditTitle.textContent = 'Add New Album';
                            
                            // Open edit modal
                            albumEditModalOverlay.classList.add('visible');
                        });
                        
                        galleryContainer.appendChild(addAlbumButton);
                    }
                    
                    // Show edit options in album modal if it's currently open
                    if (albumDetailModalOverlay.classList.contains('visible') && modalEditOptions) {
                        modalEditOptions.style.display = 'flex';
                    }
                } else {
                    // Remove delete buttons from requests
                    requestItems.forEach(item => {
                        const deleteButton = item.querySelector('.delete-request-button');
                        if (deleteButton) {
                            deleteButton.remove();
                        }
                    });
                    
                    // Remove "Add Album" button if exists
                    const addAlbumButton = document.getElementById('add-album-button');
                    if (addAlbumButton) {
                        addAlbumButton.remove();
                    }
                    
                    // Hide edit options in album modal if it's currently open
                    if (albumDetailModalOverlay.classList.contains('visible') && modalEditOptions) {
                        modalEditOptions.style.display = 'none';
                    }
                }
            }

            async function renderRequests() {
                const requestsList = document.querySelector('.requests-list');
                requestsList.innerHTML = '<h4>Requests:</h4>'; // Clear existing requests except the title

                const requests = await getRequests(); // Fetch requests from server

                if (requests.length === 0) {
                    const initialPlaceholder = document.createElement('div');
                    initialPlaceholder.id = 'initial-request-placeholder';
                    initialPlaceholder.classList.add('request-item');
                    initialPlaceholder.textContent = '//';
                    requestsList.appendChild(initialPlaceholder);
                    
                    // Remove scrollable class if no requests
                    requestsList.classList.remove('scrollable');
                } else {
                    // Sort all requests by timestamp (newest first)
                    const sortedRequests = requests.sort((a, b) => b.timestamp - a.timestamp);

                    // Render each request as a separate item
                    sortedRequests.forEach((req) => {
                        const newRequestItem = document.createElement('div');
                        newRequestItem.classList.add('request-item');
                        newRequestItem.classList.add(req.designType);
                        newRequestItem.setAttribute('data-request-id', req.id);

                        const requestUsernameDiv = document.createElement('div');
                        requestUsernameDiv.classList.add('request-username');
                        requestUsernameDiv.textContent = req.username;
                        requestUsernameDiv.classList.add(req.designType);
                        requestUsernameDiv.setAttribute('data-id-name', req.idName);

                        const requestSeparatorDiv = document.createElement('div');
                        requestSeparatorDiv.classList.add('request-separator');
                        requestSeparatorDiv.textContent = '|';

                        const requestTextDiv = document.createElement('div');
                        requestTextDiv.classList.add('request-text');
                        requestTextDiv.textContent = req.text;

                        const requestTimeDiv = document.createElement('div');
                        requestTimeDiv.classList.add('request-time');
                        
                        // Calculate relative time
                        const relativeTime = getRelativeTimeString(req.timestamp);
                        requestTimeDiv.textContent = relativeTime;

                        newRequestItem.appendChild(requestUsernameDiv);
                        newRequestItem.appendChild(requestSeparatorDiv);
                        newRequestItem.appendChild(requestTextDiv);
                        newRequestItem.appendChild(requestTimeDiv);

                        requestsList.appendChild(newRequestItem);
                    });
                    
                    // Add scrollable class if more than 3 requests
                    if (sortedRequests.length > 3) {
                        requestsList.classList.add('scrollable');
                    } else {
                        requestsList.classList.remove('scrollable');
                    }
                }
                setupHoverEffects();
                toggleAdminView(requestSection.classList.contains('admin-mode'));
            }

            // Function to calculate relative time string (1m, 1h1m, 1d, etc.)
            function getRelativeTimeString(timestamp) {
                if (!timestamp) return 'unknown';
                
                const now = Date.now();
                const diffMs = now - timestamp;
                
                // Convert to seconds, minutes, hours, days
                const seconds = Math.floor(diffMs / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                
                // Format the relative time string
                if (days > 0) {
                    const remainingHours = hours % 24;
                    if (remainingHours > 0) {
                        return `${days}d ${remainingHours}h`;
                    }
                    return `${days}d`;
                } else if (hours > 0) {
                    const remainingMinutes = minutes % 60;
                    if (remainingMinutes > 0) {
                        return `${hours}h ${remainingMinutes}m`;
                    }
                    return `${hours}h`;
                } else if (minutes > 0) {
                    return `${minutes}m`;
                } else {
                    return 'now';
                }
            }

            // Set the callback for request updates from db.js
            setRequestUpdateCallback(() => {
                console.log('Live update: Requests changed');
                renderRequests(); // Automatically re-render requests when updates occur
            });

            // Set the callback for album updates from db.js
            setAlbumItemUpdateCallback(() => {
                console.log('Live update: Albums changed');
                renderAlbums(); // Automatically re-render albums when updates occur
            });

            renderRequests(); // Initial render of requests on page load
            renderAlbums(); // Initial render of albums on page load
            clearSearchResults(); // Initialize search results

            // --- View All Albums Button & Modal Logic ---
            const viewAllButton = document.querySelector('.view-all-button');
            const viewAllModalOverlay = document.getElementById('view-all-modal-overlay');
            const viewAllModal = document.getElementById('view-all-modal');
            const viewAllCloseButton = viewAllModal.querySelector('.close-button');
            const albumsGrid = document.getElementById('albums-grid');
            
            // Open modal when View All button is clicked
            viewAllButton.addEventListener('click', () => {
                renderAllAlbums();
                viewAllModalOverlay.classList.add('visible');
                // Ensure smooth scrolling behavior
                viewAllModal.scrollTop = 0;
            });
            
            // Close modal when close button or outside area is clicked
            viewAllCloseButton.addEventListener('click', () => {
                viewAllModalOverlay.classList.remove('visible');
            });
            
            viewAllModalOverlay.addEventListener('click', (e) => {
                if (e.target === viewAllModalOverlay) {
                    viewAllModalOverlay.classList.remove('visible');
                }
            });
            
            // Render all albums in the grid
            async function renderAllAlbums() {
                try {
                    // Clear the grid
                    albumsGrid.innerHTML = '';
                    
                    // Create 10x10 grid (100 slots max)
                    const totalSlots = 100;
                    
                    // Fill the grid with existing albums first
                    for (let i = 0; i < totalSlots; i++) {
                        const gridItem = document.createElement('div');
                        gridItem.classList.add('grid-album-item');
                        
                        const gridImage = document.createElement('div');
                        gridImage.classList.add('grid-album-image');
                        
                        const gridName = document.createElement('div');
                        gridName.classList.add('grid-album-name');
                        
                        if (i < albumItems.length) {
                            // Fill with actual album data
                            const album = albumItems[i];
                            
                            if (album.imageUrl && album.imageUrl.trim() !== '') {
                                gridImage.style.backgroundImage = `url(${album.imageUrl})`;
                                gridImage.style.backgroundSize = 'cover';
                                gridImage.style.backgroundPosition = 'center';
                } else {
                                const placeholderText = document.createElement('div');
                                placeholderText.textContent = `Album ${i + 1}`;
                                gridImage.appendChild(placeholderText);
                            }
                            
                            gridName.textContent = album.name;
                            
                            // Store album data for detail view
                            gridItem.dataset.albumId = album.id;
                            gridItem.dataset.albumName = album.name;
                            gridItem.dataset.albumAcc = album.acc;
                            gridItem.dataset.albumPw = album.pw;
                            gridItem.dataset.albumImageUrl = album.imageUrl;
                            
                            // Add click event to show details
                            gridItem.addEventListener('click', () => {
                                showAlbumDetails(album);
                            });
                        } else {
                            // Empty slot
                            gridName.textContent = 'Empty';
                            
                            const placeholderText = document.createElement('div');
                            placeholderText.textContent = 'Empty';
                            gridImage.appendChild(placeholderText);
                            
                            // If we're in admin mode, allow adding new album
                            if (requestSection.classList.contains('admin-mode')) {
                                gridItem.addEventListener('click', () => {
                                    // Open add album modal
                                    editAlbumId.value = '';
                                    editAlbumName.value = '';
                                    editAlbumImageUrl.value = '';
                                    editAlbumAcc.value = '';
                                    editAlbumPw.value = '';
                                    
                                    albumEditTitle.textContent = 'Add New Album';
                                    
                                    viewAllModalOverlay.classList.remove('visible');
                                    albumEditModalOverlay.classList.add('visible');
                    });
                }
            }

                        gridItem.appendChild(gridImage);
                        gridItem.appendChild(gridName);
                        albumsGrid.appendChild(gridItem);
                    }
                } catch (error) {
                    console.error('Error rendering all albums:', error);
                }
            }
            
            function showAlbumDetails(album) {
                modalAlbumName.textContent = album.name;
                
                // Set ACC button
                if (album.acc && album.acc !== 'Empty') {
                    copyAccButton.textContent = 'Copy ACC';
                    copyAccButton.setAttribute('data-clipboard-text', album.acc);
                    copyAccButton.classList.remove('is-empty');
                    copyAccButton.style.cursor = 'pointer';
                } else {
                    copyAccButton.textContent = 'Empty';
                    copyAccButton.setAttribute('data-clipboard-text', 'Empty');
                    copyAccButton.classList.add('is-empty');
                    copyAccButton.style.cursor = 'not-allowed';
                }
                copyAccButton.classList.add('gradient-animated');
                
                // Set PW button
                if (album.pw && album.pw !== 'Empty') {
                    copyPwButton.textContent = 'Copy PW';
                    copyPwButton.setAttribute('data-clipboard-text', album.pw);
                    copyPwButton.classList.remove('is-empty');
                    copyPwButton.style.cursor = 'pointer';
                } else {
                    copyPwButton.textContent = 'Empty';
                    copyPwButton.setAttribute('data-clipboard-text', 'Empty');
                    copyPwButton.classList.add('is-empty');
                    copyPwButton.style.cursor = 'not-allowed';
                }
                copyPwButton.classList.add('gradient-animated');
                
                // Update modal image if available
                const modalImage = albumDetailModal.querySelector('.modal-image-placeholder');
                if (album.imageUrl && album.imageUrl.trim() !== '') {
                    modalImage.style.backgroundImage = `url(${album.imageUrl})`;
                    modalImage.style.backgroundSize = 'cover';
                    modalImage.style.backgroundPosition = 'center';
                    modalImage.textContent = '';
                } else {
                    modalImage.style.backgroundImage = 'none';
                    modalImage.textContent = 'No Image Available';
                }
                
                // Set up edit/delete options for admin mode
                const modalEditOptions = albumDetailModal.querySelector('.modal-edit-options');
                if (modalEditOptions) {
                    const isAdminMode = requestSection.classList.contains('admin-mode');
                    modalEditOptions.style.display = isAdminMode ? 'flex' : 'none';
                    
                    modalEditOptions.setAttribute('data-album-id', album.id || '');
                    modalEditOptions.setAttribute('data-album-name', album.name || '');
                    modalEditOptions.setAttribute('data-album-imageurl', album.imageUrl || '');
                    modalEditOptions.setAttribute('data-album-acc', album.acc || 'Empty');
                    modalEditOptions.setAttribute('data-album-pw', album.pw || 'Empty');
                }
                
                // Close grid view and show detail modal
                viewAllModalOverlay.classList.remove('visible');
                albumDetailModalOverlay.classList.add('visible');
            }

            // --- Album Detail Modal Logic ---
            const albumDetailModalOverlay = document.getElementById('album-detail-modal-overlay');
            const albumDetailModal = document.getElementById('album-detail-modal');
            const modalCloseButton = albumDetailModal.querySelector('.close-button');
            const modalAlbumName = albumDetailModal.querySelector('.modal-album-name');
            const copyAccButton = albumDetailModal.querySelector('.copy-acc-button');
            const copyPwButton = albumDetailModal.querySelector('.copy-pw-button');
            const modalEditOptions = albumDetailModal.querySelector('.modal-edit-options');
            const editAlbumButton = modalEditOptions.querySelector('.edit-album-button');
            const deleteAlbumButton = modalEditOptions.querySelector('.delete-album-button');
            
            // Report button elements
            const reportButton = albumDetailModal.querySelector('.report-album-button');
            const reportConfirmation = albumDetailModal.querySelector('.report-confirmation');
            const reportYesButton = albumDetailModal.querySelector('.report-yes-button');
            const reportNoButton = albumDetailModal.querySelector('.report-no-button');
            
            // Album Edit Modal Elements
            const albumEditModalOverlay = document.getElementById('album-edit-modal-overlay');
            const albumEditModal = document.getElementById('album-edit-modal');
            const editModalCloseButton = albumEditModal.querySelector('.close-button');
            const albumEditForm = document.getElementById('album-edit-form');
            const editAlbumId = document.getElementById('edit-album-id');
            const editAlbumName = document.getElementById('edit-album-name');
            const editAlbumImageUrl = document.getElementById('edit-album-image-url');
            const editAlbumAcc = document.getElementById('edit-album-acc');
            const editAlbumPw = document.getElementById('edit-album-pw');
            const albumEditTitle = document.getElementById('album-edit-title');
            
            let currentAlbumId = null;
            let currentAlbumName = null;

            modalCloseButton.addEventListener('click', () => {
                albumDetailModalOverlay.classList.remove('visible');
            });

            editModalCloseButton.addEventListener('click', () => {
                albumEditModalOverlay.classList.remove('visible');
            });

            albumDetailModalOverlay.addEventListener('click', (e) => {
                if (e.target === albumDetailModalOverlay) {
                    albumDetailModalOverlay.classList.remove('visible');
                }
            });

            albumEditModalOverlay.addEventListener('click', (e) => {
                if (e.target === albumEditModalOverlay) {
                    albumEditModalOverlay.classList.remove('visible');
                }
            });

            // Setup album item callbacks
            setAlbumItemUpdateCallback(renderAlbums);

            function copyToClipboard(button, text) {
                if (text === 'Empty') {
                    return;
                }

                navigator.clipboard.writeText(text).then(() => {
                    const originalText = button.textContent;

                    button.textContent = 'Copied!';
                    button.classList.add('copied');

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('copied');
                    }, 1500);
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                    alert('Failed to copy. Please try again or copy manually.');
                });
            }

            copyAccButton.addEventListener('click', () => {
                const textToCopy = copyAccButton.getAttribute('data-clipboard-text');
                if (textToCopy) {
                    copyToClipboard(copyAccButton, textToCopy);
                }
            });

            copyPwButton.addEventListener('click', () => {
                const textToCopy = copyPwButton.getAttribute('data-clipboard-text');
                if (textToCopy) {
                    copyToClipboard(copyPwButton, textToCopy);
                }
            });

            // Edit & Delete Album buttons
            editAlbumButton.addEventListener('click', () => {
                const albumId = modalEditOptions.getAttribute('data-album-id');
                const albumName = modalEditOptions.getAttribute('data-album-name');
                const albumImageUrl = modalEditOptions.getAttribute('data-album-imageurl');
                const albumAcc = modalEditOptions.getAttribute('data-album-acc');
                const albumPw = modalEditOptions.getAttribute('data-album-pw');
                
                // Set form values
                editAlbumId.value = albumId;
                editAlbumName.value = albumName;
                editAlbumImageUrl.value = albumImageUrl;
                editAlbumAcc.value = albumAcc;
                editAlbumPw.value = albumPw;
                
                // Set form title
                albumEditTitle.textContent = 'Edit Album';
                
                // Close detail modal and open edit modal
                albumDetailModalOverlay.classList.remove('visible');
                albumEditModalOverlay.classList.add('visible');
            });
            
            deleteAlbumButton.addEventListener('click', async () => {
                const albumId = modalEditOptions.getAttribute('data-album-id');
                const albumName = modalEditOptions.getAttribute('data-album-name');
                
                console.log('Delete');
                
                if (!albumId) {
                    console.error('Missing');
                    alert('Cannot delete album: Missing album ID');
                    return;
                }
                
                if (confirm(`Are you sure you want to delete the album "${albumName}"?`)) {
                    try {
                        console.log('Deleting');
                        await deleteAlbumItem(albumId);
                        console.log('Deleted');
                        albumDetailModalOverlay.classList.remove('visible');
                    } catch (error) {
                        console.error('Failed');
                        alert(`Failed to delete album: ${error.message}`);
                    }
                }
            });
            
            // Album Edit Form Submit
            albumEditForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const albumData = {
                    name: editAlbumName.value,
                    imageUrl: editAlbumImageUrl.value,
                    acc: editAlbumAcc.value || 'Empty',
                    pw: editAlbumPw.value || 'Empty'
                };
                
                try {
                    if (editAlbumId.value) {
                        // Update existing album
                        await updateAlbumItem(editAlbumId.value, albumData);
                } else {
                        // Create new album
                        await addAlbumItem(albumData);
                    }
                    
                    // Close edit modal
                    albumEditModalOverlay.classList.remove('visible');
                } catch (error) {
                    console.error('Failed to save album:', error);
                    alert('Failed to save album. Please try again.');
                }
            });

            let hoverStepTimeout = null;
            let hoverStepInterval = null;
            let hoverTarget = null;

            function stepToTarget() {
                if (hoverTarget === null || Math.abs(hoverTarget - current) <= 1) {
                    if (hoverStepInterval) clearInterval(hoverStepInterval);
                    hoverStepInterval = null;
                    return;
                }
                let dir = hoverTarget > current ? 1 : -1;
                goto(current + dir);
            }

            window.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') goto(current - 1);
                if (e.key === 'ArrowRight') goto(current + 1);
                resetCarouselTimer();
            });

            galleryContent.addEventListener('wheel', resetCarouselTimer);
            galleryContent.addEventListener('mousedown', resetCarouselTimer);
            galleryContent.addEventListener('mousemove', resetCarouselTimer);
            galleryContent.addEventListener('mouseup', resetCarouselTimer);
            galleryContent.addEventListener('mouseleave', resetCarouselTimer);
            galleryContent.addEventListener('touchstart', resetCarouselTimer);
            galleryContent.addEventListener('touchmove', resetCarouselTimer);
            galleryContent.addEventListener('touchend', resetCarouselTimer);

            // Report button functionality
            reportButton.addEventListener('click', () => {
                reportConfirmation.style.display = 'block';
            });
            
            reportNoButton.addEventListener('click', () => {
                reportConfirmation.style.display = 'none';
            });
            
            reportYesButton.addEventListener('click', async () => {
                try {
                    const loggedInUser = getLoggedInUser();
                    if (!loggedInUser) {
                        alert('You must be logged in to report albums');
                        return;
                    }
                    
                    const albumId = currentAlbumId || modalEditOptions.getAttribute('data-album-id');
                    const albumName = currentAlbumName || modalEditOptions.getAttribute('data-album-name');
                    
                    // Sofort Report-Button ausblenden und Confirmation verstecken
                    reportButton.style.opacity = '0';
                    reportButton.style.visibility = 'hidden';
                    reportConfirmation.style.display = 'none';
                    
                    // Erfolgsmeldung sofort erstellen und anzeigen
                    const successMessage = document.createElement('div');
                    successMessage.textContent = 'Game reported successfully';
                    successMessage.classList.add('report-success-message');
                    
                    // Add the message to the modal body
                    const reportButtonContainer = albumDetailModal.querySelector('.report-button-container');
                    reportButtonContainer.appendChild(successMessage);
                    
                    // Create report notification
                    const notificationMessage = `Album reported: "${albumName}" by ${loggedInUser.idName}`;
                    const logId = Date.now().toString();
                    
                    // Send report to server
                    const response = await fetch('/api/report-album', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Session-Token': loggedInUser.securityId || ''
                        },
                        body: JSON.stringify({
                            id: logId,
                            albumId,
                            albumName,
                            reportedBy: loggedInUser.idName,
                            timestamp: Date.now(),
                            message: notificationMessage
                        })
                    });
                    
                    if (response.ok) {
                        // Erfolgsmeldung nach 3 Sekunden ausblenden
                        setTimeout(() => {
                            successMessage.style.opacity = '0';
                            
                            setTimeout(() => {
                                if (reportButtonContainer.contains(successMessage)) {
                                    reportButtonContainer.removeChild(successMessage);
                                }
                                // Report-Button wieder einblenden
                                setTimeout(() => {
                                    reportButton.style.visibility = 'visible';
                                    reportButton.style.opacity = '1';
                                }, 100);
                            }, 300);
                        }, 3000);
                    } else {
                        // Bei Fehler Meldung entfernen und Button wieder anzeigen
                        if (reportButtonContainer.contains(successMessage)) {
                            reportButtonContainer.removeChild(successMessage);
                        }
                        alert('Failed to report album');
                        reportButton.style.visibility = 'visible';
                        reportButton.style.opacity = '1';
                    }
                } catch (error) {
                    console.error('Report error');
                    alert('An error occurred while reporting the album');
                    // Show report button again if error
                    reportButton.style.visibility = 'visible';
                    reportButton.style.opacity = '1';
                }
            });

            // Update showAlbumDetails function to store current album info for reporting
            function showAlbumDetails(album) {
                modalAlbumName.textContent = album.name;
                currentAlbumId = album.id;
                currentAlbumName = album.name;
                
                // Set ACC button
                if (album.acc && album.acc !== 'Empty') {
                    copyAccButton.textContent = 'Copy ACC';
                    copyAccButton.setAttribute('data-clipboard-text', album.acc);
                    copyAccButton.classList.remove('is-empty');
                    copyAccButton.style.cursor = 'pointer';
                } else {
                    copyAccButton.textContent = 'Empty';
                    copyAccButton.setAttribute('data-clipboard-text', 'Empty');
                    copyAccButton.classList.add('is-empty');
                    copyAccButton.style.cursor = 'not-allowed';
                }
                copyAccButton.classList.add('gradient-animated');
                
                // Set PW button
                if (album.pw && album.pw !== 'Empty') {
                    copyPwButton.textContent = 'Copy PW';
                    copyPwButton.setAttribute('data-clipboard-text', album.pw);
                    copyPwButton.classList.remove('is-empty');
                    copyPwButton.style.cursor = 'pointer';
                } else {
                    copyPwButton.textContent = 'Empty';
                    copyPwButton.setAttribute('data-clipboard-text', 'Empty');
                    copyPwButton.classList.add('is-empty');
                    copyPwButton.style.cursor = 'not-allowed';
                }
                copyPwButton.classList.add('gradient-animated');
                
                // Update modal image if available
                const modalImage = albumDetailModal.querySelector('.modal-image-placeholder');
                if (album.imageUrl && album.imageUrl.trim() !== '') {
                    modalImage.style.backgroundImage = `url(${album.imageUrl})`;
                    modalImage.style.backgroundSize = 'cover';
                    modalImage.style.backgroundPosition = 'center';
                    modalImage.textContent = '';
                } else {
                    modalImage.style.backgroundImage = 'none';
                    modalImage.textContent = 'No Image Available';
                }
                
                // Set up edit/delete options for admin mode
                const modalEditOptions = albumDetailModal.querySelector('.modal-edit-options');
                if (modalEditOptions) {
                    const isAdminMode = requestSection.classList.contains('admin-mode');
                    modalEditOptions.style.display = isAdminMode ? 'flex' : 'none';
                    
                    modalEditOptions.setAttribute('data-album-id', album.id || '');
                    modalEditOptions.setAttribute('data-album-name', album.name || '');
                    modalEditOptions.setAttribute('data-album-imageurl', album.imageUrl || '');
                    modalEditOptions.setAttribute('data-album-acc', album.acc || 'Empty');
                    modalEditOptions.setAttribute('data-album-pw', album.pw || 'Empty');
                }
                
                // Reset report confirmation
                reportConfirmation.style.display = 'none';
                
                // Show the modal
                albumDetailModalOverlay.classList.add('visible');
            }

            // --- CHAT FUNCTIONALITY ---
            let chatMessages = [];
            const chatPill = document.querySelector('.chat-pill');
            const chatModalOverlay = document.getElementById('chat-modal-overlay');
            const chatModal = document.getElementById('chat-modal');
            const chatMessagesContainer = document.getElementById('chat-messages');
            const chatInput = document.getElementById('chat-input');
            const chatSendButton = document.getElementById('chat-send-button');
            const chatCloseButton = chatModal.querySelector('.close-button');
            
            // Open chat modal when chat pill is clicked
            chatPill.addEventListener('click', () => {
                renderChatMessages();
                chatModalOverlay.classList.add('visible');
                chatModalOverlay.classList.remove('hidden');
                // Focus input field when modal opens
                setTimeout(() => {
                    chatInput.focus();
                }, 300);
            });
            
            // Close chat modal when close button or outside area is clicked
            chatCloseButton.addEventListener('click', () => {
                chatModalOverlay.classList.remove('visible');
                chatModalOverlay.classList.add('hidden');
            });
            
            chatModalOverlay.addEventListener('click', (e) => {
                if (e.target === chatModalOverlay) {
                    chatModalOverlay.classList.remove('visible');
                    chatModalOverlay.classList.add('hidden');
                }
            });
            
            // Send message when Send button is clicked or Enter is pressed
            chatSendButton.addEventListener('click', sendChatMessage);
            
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // Function to send chat message
            async function sendChatMessage() {
                const text = chatInput.value.trim();
                const username = document.getElementById('chat-username').value.trim();
                
                if (!text) return;
                if (!username) {
                    alert('Please enter a username');
                    return;
                }
                
                const user = getLoggedInUser();
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                
                try {
                    const messageData = {
                        username: username, // Use the entered username
                        text: text,
                        designType: user.designType,
                        idName: user.idName
                    };
                    
                    await addChatMessage(messageData);
                    chatInput.value = '';
                    chatInput.focus();
                    
                    // No need to manually render; the socket event will trigger a re-render
                } catch (error) {
                    // Silently handle error
                }
            }
            
            // Function to calculate remaining time until message expires
            function getRemainingTimeString(expiresAt) {
                const now = Date.now();
                const remainingMs = expiresAt - now;
                
                if (remainingMs <= 0) {
                    return 'expiring...';
                }
                
                const seconds = Math.floor((remainingMs / 1000) % 60);
                const minutes = Math.floor((remainingMs / (1000 * 60)) % 60);
                const hours = Math.floor((remainingMs / (1000 * 60 * 60)) % 24);
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                } else if (minutes > 0) {
                    return `${minutes}m ${seconds}s`;
                } else {
                    return `${seconds}s`;
                }
            }
            
            // Set up real-time updates for chat messages
            setChatMessageUpdateCallback(() => {
                if (chatModalOverlay.classList.contains('visible')) {
                    renderChatMessages();
                }
            });
            
            // Render chat messages
            async function renderChatMessages() {
                try {
                    chatMessages = await getChatMessages();
                    chatMessagesContainer.innerHTML = '';
                    
                    if (chatMessages.length === 0) {
                        const emptyMessage = document.createElement('div');
                        emptyMessage.textContent = 'No messages yet. Be the first to send one!';
                        emptyMessage.classList.add('empty-chat-message');
                        chatMessagesContainer.appendChild(emptyMessage);
                        return;
                    }
                    
                    // Create and append message elements
                    chatMessages.forEach(message => {
                        const messageElement = createChatMessageElement(message);
                        chatMessagesContainer.appendChild(messageElement);
                    });
                    
                    // Update expiry timers
                    updateExpiryTimers();
                } catch (error) {
                    // Silently handle error
                }
            }
            
            // Create a message element
            function createChatMessageElement(message) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('chat-message');
                messageElement.classList.add(message.designType); // Add the designType as a class
                
                const messageHeader = document.createElement('div');
                messageHeader.classList.add('chat-message-header');
                
                const messageSender = document.createElement('span');
                messageSender.classList.add('chat-message-sender');
                messageSender.textContent = message.username; // Use the username instead of idName
                
                const messageTime = document.createElement('span');
                messageTime.classList.add('chat-message-time');
                messageTime.textContent = message.time;
                
                messageHeader.appendChild(messageSender);
                messageHeader.appendChild(messageTime);
                
                const messageText = document.createElement('div');
                messageText.classList.add('chat-message-text');
                messageText.textContent = message.text;
                
                const messageExpiry = document.createElement('div');
                messageExpiry.classList.add('chat-message-expiry');
                messageExpiry.setAttribute('data-expires-at', message.expiresAt);
                messageExpiry.textContent = getRemainingTimeString(message.expiresAt);
                
                messageElement.appendChild(messageHeader);
                messageElement.appendChild(messageText);
                messageElement.appendChild(messageExpiry);
                
                return messageElement;
            }
            
            // Update expiry timers every second
            function updateExpiryTimers() {
                const expiryElements = document.querySelectorAll('.chat-message-expiry');
                
                expiryElements.forEach(el => {
                    const expiresAt = parseInt(el.getAttribute('data-expires-at'));
                    el.textContent = getRemainingTimeString(expiresAt);
                });
            }
            
            // Set interval to update expiry timers every second
            const expiryUpdateInterval = setInterval(updateExpiryTimers, 1000);
            
            // Render chat messages initially
            renderChatMessages();
            
            // Set the callback for request updates from db.js
            setRequestUpdateCallback(() => {
                renderRequests(); // Automatically re-render requests when updates occur
            });
            
            // Set the callback for album updates from db.js
            setAlbumItemUpdateCallback(() => {
                renderAlbums(); // Automatically re-render albums when updates occur
            });

            /* ------------------------------------------------------------------
             * NAVIGATION BAR LOGIC
             * ------------------------------------------------------------------ */
            const navItems = document.querySelectorAll('#top-nav li');
            const searchWrapperEl = document.querySelector('.search-wrapper');
            const mainTitleContainerEl = document.querySelector('.main-title-container');
            const galleryContainerEl = document.querySelector('.gallery-container');

            function setActiveNav(target) {
                navItems.forEach(li => li.classList.toggle('active', li.dataset.target === target));
            }

            function showSearchView() {
                // Show search related elements
                mainScreen.style.display = '';
                if (searchWrapperEl) searchWrapperEl.style.display = '';
                if (mainTitleContainerEl) mainTitleContainerEl.style.display = '';
                if (galleryContainerEl) galleryContainerEl.style.display = '';
                // Hide request section inside main screen
                if (requestSection) requestSection.style.display = 'none';
                // Hide chat modal overlay
                chatModalOverlay.classList.remove('visible');
                chatModalOverlay.classList.add('hidden');
                setActiveNav('search');
            }

            function showChatView() {
                // Hide main screen completely for full chat space
                mainScreen.style.display = 'none';
                // Show chat modal overlay
                chatModalOverlay.classList.add('visible');
                chatModalOverlay.classList.remove('hidden');
                setActiveNav('chat');
            }

            function showRequestView() {
                // Show main screen but hide search specific elements
                mainScreen.style.display = '';
                if (searchWrapperEl) searchWrapperEl.style.display = 'none';
                if (mainTitleContainerEl) mainTitleContainerEl.style.display = 'none';
                if (galleryContainerEl) galleryContainerEl.style.display = 'none';
                // Show request section
                if (requestSection) requestSection.style.display = 'block';
                // Hide chat overlay if open
                chatModalOverlay.classList.remove('visible');
                chatModalOverlay.classList.add('hidden');
                setActiveNav('requests');
            }

            navItems.forEach(li => {
                li.addEventListener('click', () => {
                    const target = li.dataset.target;
                    if (target === 'search') {
                        showSearchView();
                    } else if (target === 'chat') {
                        showChatView();
                    } else if (target === 'requests') {
                        showRequestView();
                    }
                });
            });

            // Initialize with search view
            showSearchView();

            /* ---------------- Helper to update new 3D carousel ---------------- */
            function update3DCarousel(items = []) {
                const carouselEl = document.getElementById('album-carousel');
                if (!carouselEl) return;
                for (let i = 0; i < 8; i++) {
                    const card = carouselEl.querySelector('.c' + (i + 1));
                    const cardBack = carouselEl.querySelector('.cb' + (i + 1));
                    if (!card || !cardBack) continue;
                    const imgDiv = card.querySelector('.img');
                    const titleP = card.querySelector('p');
                    const item = (items[i]) ? items[i] : null;

                    if (item) {
                        if (imgDiv && item.imageUrl) {
                            imgDiv.style.backgroundImage = `url(${item.imageUrl})`;
                        }
                        if (titleP) titleP.textContent = item.name || `Image ${8 - i}`;
                        card.onclick = () => showAlbumDetails(item);
                    } else {
                        if (imgDiv) imgDiv.style.backgroundImage = `url(https://picsum.photos/300/300.webp?random=${i + 1})`;
                        if (titleP) titleP.textContent = `Image ${8 - i}`;
                        card.onclick = null;
                    }

                    /* Positioning (ensure CSS fallback) */
                    const angle = (360 / 8) * (i + 1);
                    card.style.transform = `rotateZ(${angle}deg) rotateX(90deg) translateY(120px) translateZ(280px) rotateZ(180deg)`;
                    cardBack.style.transform = `rotateZ(${angle}deg) rotateX(90deg) translateY(120px) translateZ(279px)`;
                }
            }
        });

        document.addEventListener('touchmove', function() {
            if (Date.now() - lastActivityTime > 2000) {
                trackUserActivity();
            }
        }, { passive: true });

        // Add explicit event listeners for important interactive elements
        const interactiveElements = [
            requestInput, 
            usernameInput, 
            sendButton, 
            searchBar,
            document.querySelector('.gallery-container'),
            document.querySelector('.view-all-button'),
            document.querySelector('.requests-list')
        ];

        // Add interaction listeners to each interactive element
        interactiveElements.forEach(element => {
            if (element) {
                element.addEventListener('click', trackUserActivity, { passive: true });
                element.addEventListener('touchstart', trackUserActivity, { passive: true });
                element.addEventListener('focus', trackUserActivity, { passive: true });
            }
        });

        // Also track modal interactions that might not bubble up properly
        document.querySelectorAll('.modal-content, .modal-body, .glassy-button').forEach(element => {
            if (element) {
                element.addEventListener('click', trackUserActivity, { passive: true });
                element.addEventListener('touchstart', trackUserActivity, { passive: true });
            }
        });
    </script>
</body>
</html>
